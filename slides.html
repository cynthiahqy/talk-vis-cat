<!DOCTYPE html>
<html lang="en"><head>
<script src="slides_files/libs/tone/tone.js"></script>
<script src="slides_files/libs/clipboard/clipboard.min.js"></script>
<script src="slides_files/libs/quarto-html/tabby.min.js"></script>
<script src="slides_files/libs/quarto-html/popper.min.js"></script>
<script src="slides_files/libs/quarto-html/tippy.umd.min.js"></script>
<link href="slides_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="slides_files/libs/quarto-html/light-border.css" rel="stylesheet">
<link href="slides_files/libs/quarto-html/quarto-html.min.css" rel="stylesheet" data-mode="light">
<link href="slides_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles"><meta charset="utf-8">
  <meta name="generator" content="quarto-1.3.433">

  <meta name="author" content="Cynthia Huang">
  <meta name="dcterms.date" content="2023-10-23">
  <title>Visualising Category Recoding and Redistributions</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="slides_files/libs/revealjs/dist/reset.css">
  <link rel="stylesheet" href="slides_files/libs/revealjs/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      { color: #003b4f; background-color: #f1f3f5; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #003b4f; } /* Normal */
    code span.al { color: #ad0000; } /* Alert */
    code span.an { color: #5e5e5e; } /* Annotation */
    code span.at { color: #657422; } /* Attribute */
    code span.bn { color: #ad0000; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #003b4f; } /* ControlFlow */
    code span.ch { color: #20794d; } /* Char */
    code span.cn { color: #8f5902; } /* Constant */
    code span.co { color: #5e5e5e; } /* Comment */
    code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
    code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
    code span.dt { color: #ad0000; } /* DataType */
    code span.dv { color: #ad0000; } /* DecVal */
    code span.er { color: #ad0000; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #ad0000; } /* Float */
    code span.fu { color: #4758ab; } /* Function */
    code span.im { color: #00769e; } /* Import */
    code span.in { color: #5e5e5e; } /* Information */
    code span.kw { color: #003b4f; } /* Keyword */
    code span.op { color: #5e5e5e; } /* Operator */
    code span.ot { color: #003b4f; } /* Other */
    code span.pp { color: #ad0000; } /* Preprocessor */
    code span.sc { color: #5e5e5e; } /* SpecialChar */
    code span.ss { color: #20794d; } /* SpecialString */
    code span.st { color: #20794d; } /* String */
    code span.va { color: #111111; } /* Variable */
    code span.vs { color: #20794d; } /* VerbatimString */
    code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="slides_files/libs/revealjs/dist/theme/quarto.css">
  <link rel="stylesheet" href="custom.css">
  <link href="slides_files/libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
  <link href="slides_files/libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
  <link href="slides_files/libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
  <link href="slides_files/libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
  <style type="text/css">

  .callout {
    margin-top: 1em;
    margin-bottom: 1em;  
    border-radius: .25rem;
  }

  .callout.callout-style-simple { 
    padding: 0em 0.5em;
    border-left: solid #acacac .3rem;
    border-right: solid 1px silver;
    border-top: solid 1px silver;
    border-bottom: solid 1px silver;
    display: flex;
  }

  .callout.callout-style-default {
    border-left: solid #acacac .3rem;
    border-right: solid 1px silver;
    border-top: solid 1px silver;
    border-bottom: solid 1px silver;
  }

  .callout .callout-body-container {
    flex-grow: 1;
  }

  .callout.callout-style-simple .callout-body {
    font-size: 1rem;
    font-weight: 400;
  }

  .callout.callout-style-default .callout-body {
    font-size: 0.9rem;
    font-weight: 400;
  }

  .callout.callout-titled.callout-style-simple .callout-body {
    margin-top: 0.2em;
  }

  .callout:not(.callout-titled) .callout-body {
      display: flex;
  }

  .callout:not(.no-icon).callout-titled.callout-style-simple .callout-content {
    padding-left: 1.6em;
  }

  .callout.callout-titled .callout-header {
    padding-top: 0.2em;
    margin-bottom: -0.2em;
  }

  .callout.callout-titled .callout-title  p {
    margin-top: 0.5em;
    margin-bottom: 0.5em;
  }
    
  .callout.callout-titled.callout-style-simple .callout-content  p {
    margin-top: 0;
  }

  .callout.callout-titled.callout-style-default .callout-content  p {
    margin-top: 0.7em;
  }

  .callout.callout-style-simple div.callout-title {
    border-bottom: none;
    font-size: .9rem;
    font-weight: 600;
    opacity: 75%;
  }

  .callout.callout-style-default  div.callout-title {
    border-bottom: none;
    font-weight: 600;
    opacity: 85%;
    font-size: 0.9rem;
    padding-left: 0.5em;
    padding-right: 0.5em;
  }

  .callout.callout-style-default div.callout-content {
    padding-left: 0.5em;
    padding-right: 0.5em;
  }

  .callout.callout-style-simple .callout-icon::before {
    height: 1rem;
    width: 1rem;
    display: inline-block;
    content: "";
    background-repeat: no-repeat;
    background-size: 1rem 1rem;
  }

  .callout.callout-style-default .callout-icon::before {
    height: 0.9rem;
    width: 0.9rem;
    display: inline-block;
    content: "";
    background-repeat: no-repeat;
    background-size: 0.9rem 0.9rem;
  }

  .callout-title {
    display: flex
  }
    
  .callout-icon::before {
    margin-top: 1rem;
    padding-right: .5rem;
  }

  .callout.no-icon::before {
    display: none !important;
  }

  .callout.callout-titled .callout-body > .callout-content > :last-child {
    margin-bottom: 0.5rem;
  }

  .callout.callout-titled .callout-icon::before {
    margin-top: .5rem;
    padding-right: .5rem;
  }

  .callout:not(.callout-titled) .callout-icon::before {
    margin-top: 1rem;
    padding-right: .5rem;
  }

  /* Callout Types */

  div.callout-note {
    border-left-color: #4582ec !important;
  }

  div.callout-note .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAAEU0lEQVRYCcVXTWhcVRQ+586kSUMMxkyaElstCto2SIhitS5Ek8xUKV2poatCcVHtUlFQk8mbaaziwpWgglJwVaquitBOfhQXFlqlzSJpFSpIYyXNjBNiTCck7x2/8/LeNDOZxDuEkgOXe++553zfefee+/OYLOXFk3+1LLrRdiO81yNqZ6K9cG0P3MeFaMIQjXssE8Z1JzLO9ls20MBZX7oG8w9GxB0goaPrW5aNMp1yOZIa7Wv6o2ykpLtmAPs/vrG14Z+6d4jpbSKuhdcSyq9wGMPXjonwmESXrriLzFGOdDBLB8Y6MNYBu0dRokSygMA/mrun8MGFN3behm6VVAwg4WR3i6FvYK1T7MHo9BK7ydH+1uurECoouk5MPRyVSBrBHMYwVobG2aOXM07sWrn5qgB60rc6mcwIDJtQrnrEr44kmy+UO9r0u9O5/YbkS9juQckLed3DyW2XV/qWBBB3ptvI8EUY3I9p/67OW+g967TNr3Sotn3IuVlfMLVnsBwH4fsnebJvyGm5GeIUA3jljERmrv49SizPYuq+z7c2H/jlGC+Ghhupn/hcapqmcudB9jwJ/3jvnvu6vu5lVzF1fXyZuZZ7U8nRmVzytvT+H3kilYvH09mLWrQdwFSsFEsxFVs5fK7A0g8gMZjbif4ACpKbjv7gNGaD8bUrlk8x+KRflttr22JEMRUbTUwwDQScyzPgedQHZT0xnx7ujw2jfVfExwYHwOsDTjLdJ2ebmeQIlJ7neo41s/DrsL3kl+W2lWvAga0tR3zueGr6GL78M3ifH0rGXrBC2aAR8uYcIA5gwV8zIE8onoh8u0Fca/ciF7j1uOzEnqcIm59sEXoGc0+z6+H45V1CvAvHcD7THztu669cnp+L0okAeIc6zjbM/24LgGM1gZk7jnRu1aQWoU9sfUOuhrmtaPIO3YY1KLLWZaEO5TKUbMY5zx8W9UJ6elpLwKXbsaZ4EFl7B4bMtDv0iRipKoDQT2sNQI9b1utXFdYisi+wzZ/ri/1m7QfDgEuvgUUEIJPq3DhX/5DWNqIXDOweC2wvIR90Oq3lDpdMIgD2r0dXvGdsEW5H6x6HLRJYU7C69VefO1x8Gde1ZFSJLfWS1jbCnhtOPxmpfv2LXOA2Xk2tvnwKKPFuZ/oRmwBwqRQDcKNeVQkYcOjtWVBuM/JuYw5b6isojIkYxyYAFn5K7ZBF10fea52y8QltAg6jnMqNHFBmGkQ1j+U43HMi2xMar1Nv0zGsf1s8nUsmUtPOOrbFIR8bHFDMB5zL13Gmr/kGlCkUzedTzzmzsaJXhYawnA3UmARpiYj5ooJZiUoxFRtK3X6pgNPv+IZVPcnwbOl6f+aBaO1CNvPW9n9LmCp01nuSaTRF2YxHqZ8DYQT6WsXT+RD6eUztwYLZ8rM+rcPxamv1VQzFUkzFXvkiVrySGQgJNvXHJAxiU3/NwiC03rSf05VBaPtu/Z7/B8Yn/w7eguloAAAAAElFTkSuQmCC');
  }

  div.callout-note.callout-style-default .callout-title {
    background-color: #dae6fb
  }

  div.callout-important {
    border-left-color: #d9534f !important;
  }

  div.callout-important .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAAEKklEQVRYCcVXTWhcVRS+575MJym48A+hSRFr00ySRQhURRfd2HYjk2SSTokuBCkU2o0LoSKKraKIBTcuFCoidGFD08nkBzdREbpQ1EDNIv8qSGMFUboImMSZd4/f9zJv8ibJMC8xJQfO3HPPPef7zrvvvnvviIkpC9nsw0UttFunbUhpFzFtarSd6WJkStVMw5xyVqYTvkwfzuf/5FgtkVoB0729j1rjXwThS7Vio+Mo6DNnvLfahoZ+i/o32lULuJ3NNiz7q6+pyAUkJaFF6JwaM2lUJlV0MlnQn5aTRbEu0SEqHUa0A4AdiGuB1kFXRfVyg5d87+Dg4DL6m2TLAub60ilj7A1Ec4odSAc8X95sHh7+ZRPCFo6Fnp7HfU/fBng/hi10CjCnWnJjsxvDNxWw0NfV6Rv5GgP3I3jGWXumdTD/3cbEOP2ZbOZp69yniG3FQ9z1jD7bnBu9Fc2tKGC2q+uAJOQHBDRiZX1x36o7fWBs7J9ownbtO+n0/qWkvW7UPIfc37WgT6ZGR++EOJyeQDSb9UB+DZ1G6DdLDzyS+b/kBCYGsYgJbSQHuThGKRcw5xdeQf8YdNHsc6ePXrlSYMBuSIAFTGAtQo+VuALo4BX83N190NWZWbynBjhOHsmNfFWLeL6v+ynsA58zDvvAC8j5PkbOcXCMg2PZFk3q8MjI7WAG/Dp9AwP7jdGBOOQkAvlFUB+irtm16I1Zw9YBcpGTGXYmk3kQIC/Cds55l+iMI3jqhjAuaoe+am2Jw5GT3Nbz3CkE12NavmzN5+erJW7046n/CH1RO/RVa8lBLozXk9uqykkGAyRXLWlLv5jyp4RFsG5vGVzpDLnIjTWgnRy2Rr+tDKvRc7Y8AyZq10jj8DqXdnIRNtFZb+t/ZRtXcDiVnzpqx8mPcDWxgARUqx0W1QB9MeUZiNrV4qP+Ehc+BpNgATsTX8ozYKL2NtFYAHc84fG7ndxUPr+AR/iQSns7uSUufAymwDOb2+NjK27lEFocm/EE2WpyIy/Hi66MWuMKJn8RvxIcj87IM5Vh9663ziW36kR0HNenXuxmfaD8JC7tfKbrhFr7LiZCrMjrzTeGx+PmkosrkNzW94ObzwocJ7A1HokLolY+AvkTiD/q1H0cN48c5EL8Crkttsa/AXQVDmutfyku0E7jShx49XqV3MFK8IryDhYVbj7Sj2P2eBxwcXoe8T8idsKKPRcnZw1b+slFTubwUwhktrfnAt7J++jwQtLZcm3sr9LQrjRzz6cfMv9aLvgmnAGvpoaGLxM4mAEaLV7iAzQ3oU0IvD5x9ix3yF2RAAuYAOO2f7PEFWCXZ4C9Pb2UsgDeVnFSpbFK7/IWu7TPTvBqzbGdCHOJQSxiEjt6IyZmxQyEJHv6xyQsYk//moVFsN2zP6fRImjfq7/n/wFDguUQFNEwugAAAABJRU5ErkJggg==');
  }

  div.callout-important.callout-style-default .callout-title {
    background-color: #f7dddc
  }

  div.callout-warning {
    border-left-color: #f0ad4e !important;
  }

  div.callout-warning .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAAETklEQVRYCeVWW2gcVRg+58yaTUnizqbipZeX4uWhBEniBaoUX1Ioze52t7sRq6APio9V9MEaoWlVsFasRq0gltaAPuxms8lu0gcviE/FFOstVbSIxgcv6SU7EZqmdc7v9+9mJtNks51NTUH84ed889/PP+cmxP+d5FIbMJmNbpREu4WUkiTtCicKny0l1pIKmBzovF2S+hIJHX8iEu3hZJ5lNZGqyRrGSIQpq15AzF28jgpeY6yk6GVdrfFqdrD6Iw+QlB8g0YS2g7dyQmXM/IDhBhT0UCiRf59lfqmmDvzRt6kByV/m4JjtzuaujMUM2c5Z2d6JdKrRb3K2q6mA+oYVz8JnDdKPmmNthzkAk/lN63sYPgevrguc72aZX/L9C6x09GYyxBgCX4NlvyGUHOKELlm5rXeR1kchuChJt4SSwyddZRXgvwMGvYo4QSlk3/zkHD8UHxwVJA6zjZZqP8v8kK8OWLnIZtLyCAJagYC4rTGW/9Pqj92N/c+LUaAj27movwbi19tk/whRCIE7Q9vyI6yvRpftAKVTdUjOW40X3h5OXsKCdmFcx0xlLJoSuQngnrJe7Kcjm4OMq9FlC7CMmScQANuNvjfP3PjGXDBaUQmbp296S5L4DrpbrHN1T87ZVEZVCzg1FF0Ft+dKrlLukI+/c9ENo+TvlTDbYFvuKPtQ9+l052rXrgKoWkDAFnvh0wTOmYn8R5f4k/jN/fZiCM1tQx9jQQ4ANhqG4hiL0qIFTGViG9DKB7GYzgubnpofgYRwO+DFjh0Zin2m4b/97EDkXkc+f6xYAPX0KK2I/7fUQuwzuwo/L3AkcjugPNixC8cHf0FyPjWlItmLxWw4Ou9YsQCr5fijMGoD/zpdRy95HRysyXA74MWOnscpO4j2y3HAVisw85hX5+AFBRSHt4ShfLFkIMXTqyKFc46xdzQM6XbAi702a7sy04J0+feReMFKp5q9esYLCqAZYw/k14E/xcLLsFElaornTuJB0svMuJINy8xkIYuL+xPAlWRceH6+HX7THJ0djLUom46zREu7tTkxwmf/FdOZ/sh6Q8qvEAiHpm4PJ4a/doJe0gH1t+aHRgCzOvBvJedEK5OFE5jpm4AGP2a8Dxe3gGJ/pAutug9Gp6he92CsSsWBaEcxGx0FHytmIpuqGkOpldqNYQK8cSoXvd+xLxXADw0kf6UkJNFtdo5MOgaLjiQOQHcn+A6h5NuL2s0qsC2LOM75PcF3yr5STuBSAcGG+meA14K/CI21HcS4LBT6tv0QAh8Dr5l93AhZzG5ZJ4VxAqdZUEl9z7WJ4aN+svMvwHHL21UKTd1mqvChH7/Za5xzXBBKrUcB0TQ+Ulgkfbi/H/YT5EptrGzsEK7tR1B7ln9BBwckYfMiuSqklSznIuoIIOM42MQO+QnduCoFCI0bpkzjCjddHPN/F+2Yu+sd9bKNpVwHhbS3LluK/0zgfwD0xYI5dXuzlQAAAABJRU5ErkJggg==');
  }

  div.callout-warning.callout-style-default .callout-title {
    background-color: #fcefdc
  }

  div.callout-tip {
    border-left-color: #02b875 !important;
  }

  div.callout-tip .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAADr0lEQVRYCe1XTWgTQRj9ZjZV8a9SPIkKgj8I1bMHsUWrqYLVg4Ue6v9BwZOxSYsIerFao7UiUryIqJcqgtpimhbBXoSCVxUFe9CTiogUrUp2Pt+3aUI2u5vdNh4dmMzOzHvvezuz8xNFM0mjnbXaNu1MvFWRXkXEyE6aYOYJpdW4IXuA4r0fo8qqSMDBU0v1HJUgVieAXxzCsdE/YJTdFcVIZQNMyhruOMJKXYFoLfIfIvVIMWdsrd+Rpd86ZmyzzjJmLStqRn0v8lzkb4rVIXvnpScOJuAn2ACC65FkPzEdEy4TPWRLJ2h7z4cArXzzaOdKlbOvKKX25Wl00jSnrwVxAg3o4dRxhO13RBSdNvH0xSARv3adTXbBdTf64IWO2vH0LT+cv4GR1DJt+DUItaQogeBX/chhbTBxEiZ6gftlDNXTrvT7co4ub5A6gp9HIcHvzTa46OS5fBeP87Qm0fQkr4FsYgVQ7Qg+ZayaDg9jhg1GkWj8RG6lkeSacrrHgDaxdoBiZPg+NXV/KifMuB6//JmYH4CntVEHy/keA6x4h4CU5oFy8GzrBS18cLJMXcljAKB6INjWsRcuZBWVaS3GDrqB7rdapVIeA+isQ57Eev9eCqzqOa81CY05VLd6SamW2wA2H3SiTbnbSxmzfp7WtKZkqy4mdyAlGx7ennghYf8voqp9cLSgKdqNfa6RdRsAAkPwRuJZNbpByn+RrJi1RXTwdi8RQF6ymDwGMAtZ6TVE+4uoKh+MYkcLsT0Hk8eAienbiGdjJHZTpmNjlbFJNKDVAp2fJlYju6IreQxQ08UJDNYdoLSl6AadO+fFuCQqVMB1NJwPm69T04Wv5WhfcWyfXQB+wXRs1pt+nCknRa0LVzSA/2B+a9+zQJadb7IyyV24YAxKp2Jqs3emZTuNnKxsah+uabKbMk7CbTgJx/zIgQYErIeTKRQ9yD9wxVof5YolPHqaWo7TD6tJlh7jQnK5z2n3+fGdggIOx2kaa2YI9QWarc5Ce1ipNWMKeSG4DysFF52KBmTNMmn5HqCFkwy34rDg05gDwgH3bBi+sgFhN/e8QvRn8kbamCOhgrZ9GJhFDgfcMHzFb6BAtjKpFhzTjwv1KCVuxHvCbsSiEz4CANnj84cwHdFXAbAOJ4LTSAawGWFn5tDhLMYz6nWeU2wJfIhmIJBefcd/A5FWQWGgrWzyORZ3Q6HuV+Jf0Bj+BTX69fm1zWgK7By1YTXchFDORywnfQ7GpzOo6S+qECrsx2ifVQAAAABJRU5ErkJggg==');
  }

  div.callout-tip.callout-style-default .callout-title {
    background-color: #ccf1e3
  }

  div.callout-caution {
    border-left-color: #fd7e14 !important;
  }

  div.callout-caution .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAACV0lEQVRYCdVWzWoUQRCuqp2ICBLJXgITZL1EfQDBW/bkzUMUD7klD+ATSHBEfAIfQO+iXsWDxJsHL96EHAwhgzlkg8nBg25XWb0zIb0zs9muYYWkoKeru+vn664fBqElyZNuyh167NXJ8Ut8McjbmEraKHkd7uAnAFku+VWdb3reSmRV8PKSLfZ0Gjn3a6Xlcq9YGb6tADjn+lUfTXtVmaZ1KwBIvFI11rRXlWlatwIAAv2asaa9mlB9wwygiDX26qaw1yYPzFXg2N1GgG0FMF8Oj+VIx7E/03lHx8UhvYyNZLN7BwSPgekXXLribw7w5/c8EF+DBK5idvDVYtEEwMeYefjjLAdEyQ3M9nfOkgnPTEkYU+sxMq0BxNR6jExrAI31H1rzvLEfRIdgcv1XEdj6QTQAS2wtstEALLG1yEZ3QhH6oDX7ExBSFEkFINXH98NTrme5IOaaA7kIfiu2L8A3qhH9zRbukdCqdsA98TdElyeMe5BI8Rs2xHRIsoTSSVFfCFCWGPn9XHb4cdobRIWABNf0add9jakDjQJpJ1bTXOJXnnRXHRf+dNL1ZV1MBRCXhMbaHqGI1JkKIL7+i8uffuP6wVQAzO7+qVEbF6NbS0LJureYcWXUUhH66nLR5rYmva+2tjRFtojkM2aD76HEGAD3tPtKM309FJg5j/K682ywcWJ3PASCcycH/22u+Bh7Aa0ehM2Fu4z0SAE81HF9RkB21c5bEn4Dzw+/qNOyXr3DCTQDMBOdhi4nAgiFDGCinIa2owCEChUwD8qzd03PG+qdW/4fDzjUMcE1ZpIAAAAASUVORK5CYII=');
  }

  div.callout-caution.callout-style-default .callout-title {
    background-color: #ffe5d0
  }

  </style>
  <style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
</head>
<body class="quarto-light">
  <div class="reveal">
    <div class="slides">

<section id="title-slide" data-background-image="_extensions/numbats/monash/images/bg-11.png" data-background-position="center" data-background-size="contain" class="quarto-title-block center">
  <h1 class="title">Visualising Category Recoding and Redistributions</h1>
  <p class="subtitle">1st IEEE Workshop on Visualization and Across Domains at IEEE VIS</p>

<div class="quarto-title-authors">
<div class="quarto-title-author">
<div class="quarto-title-author-name">
Cynthia Huang 
</div>
<div class="quarto-title-author-email">
<a href="mailto:<p>supervised by Prof.&nbsp;Rob J Hyndman and Dr.&nbsp;Sarah Goodwin</p>"><p>supervised by Prof.&nbsp;Rob J Hyndman and Dr.&nbsp;Sarah Goodwin</p></a>
</div>
        <p class="quarto-title-affiliation">
            Department of Econometrics and Business Statistics, Monash University
          </p>
    </div>
</div>

  <p class="date">2023-10-23</p>
</section>
<section id="overview" class="slide level2">
<h2>Overview</h2>
<div class="columns v-center-container">
<div class="column" style="width:33.33%;">
<p><span class="overview-text">Domain Context</span> <img data-src="images/icon-official-stats.png" data-fig-align="center" height="300"></p>
<p><span class="fragment overview-text">Official Statistics+</span></p>
</div><div class="column" style="width:33.33%;">
<p><span class="overview-text">Task Abstraction</span> <img data-src="images/icon-database.png" data-fig-align="center" height="300"></p>
<p><span class="fragment overview-text">Data Wrangling</span></p>
</div><div class="column" style="width:33.33%;">
<p><span class="overview-text">Encoding Design<sup>1</sup></span> <img data-src="images/icon-IEEE-VIS.png" data-fig-align="center" height="300"></p>
<p><span class="fragment overview-text">Bi-graph Visualisation</span></p>
</div>
</div>
<!-- [spacer]{style="visibility: hidden; transform: rotate(90deg);"} -->
<aside><ol class="aside-footnotes"><li id="fn1"><p>Munzner, Tamara. “A nested model for visualization design and validation.” IEEE transactions on visualization and computer graphics 15.6 (2009): 921-928.</p></li></ol></aside></section>
<section>
<section id="domain-context" class="title-slide slide level1 center">
<h1>Domain Context</h1>

</section>
<section id="ex-post-harmonisation-a-non-technical-definition" class="slide level2">
<h2>Ex-Post Harmonisation (a non-technical definition)</h2>
<ul>
<li>Combining <strong>semantically related</strong> data collected under <strong>different taxonomies</strong> into a single analysis dataset.</li>
</ul>
<div class="fragment">
<div class="smaller">
<div class="cell">
<div class="cell-output-display">
<table data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">anzsco22</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">anzsco22_descr</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">111111</td>
<td style="text-align: left;">Chief Executive or Managing Director</td>
<td style="text-align: right;">1000</td>
</tr>
<tr class="even">
<td style="text-align: left;">111211</td>
<td style="text-align: left;">Corporate General Manager</td>
<td style="text-align: right;">500</td>
</tr>
<tr class="odd">
<td style="text-align: left;">111212</td>
<td style="text-align: left;">Defence Force Senior Officer</td>
<td style="text-align: right;">40</td>
</tr>
<tr class="even">
<td style="text-align: left;">111311</td>
<td style="text-align: left;">Local Government Legislator</td>
<td style="text-align: right;">300</td>
</tr>
<tr class="odd">
<td style="text-align: left;">111312</td>
<td style="text-align: left;">Member of Parliament</td>
<td style="text-align: right;">150</td>
</tr>
<tr class="even">
<td style="text-align: left;">111399</td>
<td style="text-align: left;">Legislators nec</td>
<td style="text-align: right;">10</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
<!-- - Involves different taxonomies across observational units (space, time etc.) -->
<!-- - Examples from Official Statistics:
  -   **Labour Statistics:** adding and deleting occupation codes
  -   **Census and Election Data:** changing statistical survey areas or electoral boundaries -->
<!-- > Ex-post (or retrospective) data harmonization refers to procedures applied to already collected data to improve the comparability and inferential equivalence of measures from different studies [@kolczynska2022; @fortierMaelstromResearchguidelines2016; @ehlingHarmonisingDataOfficial2003] -->
</div>
</section>
</section>
<section>
<section id="task-abstraction" class="title-slide slide level1 center">
<h1>Task Abstraction</h1>

</section>
<section id="cross-taxonomy-transformations" class="slide level2">
<h2>Cross-Taxonomy Transformations</h2>

<img data-src="images/diagram_expost-tasks.png" class="r-stretch quarto-figure-center"></section>
<section id="existing-approaches" class="slide level2">
<h2>Existing Approaches</h2>
<aside class="notes">
<p>before / after approach</p>
<style type="text/css">
        span.MJX_Assistive_MathML {
          position:absolute!important;
          clip: rect(1px, 1px, 1px, 1px);
          padding: 1px 0 0 0!important;
          border: 0!important;
          height: 1px!important;
          width: 1px!important;
          overflow: hidden!important;
          display:block!important;
      }</style></aside>
<div class="columns">
<div class="column" style="width:45%;">
<div class="quarto-figure quarto-figure-center" style="margin: 0; padding: 0; ">
<figure>
<p><img data-src="images/diagram-data-transform-script-v2.png" height="400"></p>
</figure>
</div>
<div>
<ul>
<li class="fragment">idiosyncratic coding scripts</li>
<li class="fragment">ad-hoc validation</li>
</ul>
</div>
</div><div class="column" style="width:55%;">
<div class="fragment">
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a>split_isiccomb <span class="ot">&lt;-</span> <span class="cf">function</span>(threefour_df){</span>
<span id="cb1-2"><a href="#cb1-2"></a>  <span class="co">#' Helper function to split isiccomb values across isic codes</span></span>
<span id="cb1-3"><a href="#cb1-3"></a>  <span class="co">#' @param threefour_df df with 3/4 digit values across isic &amp; isiccomb</span></span>
<span id="cb1-4"><a href="#cb1-4"></a>  </span>
<span id="cb1-5"><a href="#cb1-5"></a>  <span class="co"># make list for interim tables</span></span>
<span id="cb1-6"><a href="#cb1-6"></a>  interim <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb1-7"><a href="#cb1-7"></a>  </span>
<span id="cb1-8"><a href="#cb1-8"></a>  <span class="co"># extract rows with isiccomb codes</span></span>
<span id="cb1-9"><a href="#cb1-9"></a>  interim<span class="sc">$</span>isiccomb.rows <span class="ot">&lt;-</span> </span>
<span id="cb1-10"><a href="#cb1-10"></a>    threefour_df <span class="sc">%&gt;%</span></span>
<span id="cb1-11"><a href="#cb1-11"></a>    <span class="fu">filter</span>(., <span class="fu">str_detect</span>(isiccomb, <span class="st">'[:alpha:]'</span>))</span>
<span id="cb1-12"><a href="#cb1-12"></a>  </span>
<span id="cb1-13"><a href="#cb1-13"></a>  <span class="co"># test that we are not losing any data through spliting</span></span>
<span id="cb1-14"><a href="#cb1-14"></a>  <span class="fu">test_that</span>(<span class="st">"No `country,year` has more than one recorded `value` per `isiccomb` group"</span>, {</span>
<span id="cb1-15"><a href="#cb1-15"></a>    rows_w_many_values_per_isiccomb <span class="ot">&lt;-</span> </span>
<span id="cb1-16"><a href="#cb1-16"></a>      interim<span class="sc">$</span>isiccomb.rows <span class="sc">%&gt;%</span></span>
<span id="cb1-17"><a href="#cb1-17"></a>      <span class="fu">group_by</span>(country, year, isiccomb) <span class="sc">%&gt;%</span></span>
<span id="cb1-18"><a href="#cb1-18"></a>      <span class="do">## get  no of recorded (not NA) values for given `country, year, isiccomb` </span></span>
<span id="cb1-19"><a href="#cb1-19"></a>      <span class="fu">summarise</span>(<span class="at">n_obs =</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(value))) <span class="sc">%&gt;%</span> </span>
<span id="cb1-20"><a href="#cb1-20"></a>      <span class="fu">filter</span>(n_obs <span class="sc">!=</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-21"><a href="#cb1-21"></a>      <span class="fu">nrow</span>()</span>
<span id="cb1-22"><a href="#cb1-22"></a>    <span class="fu">expect_true</span>(rows_w_many_values_per_isiccomb <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb1-23"><a href="#cb1-23"></a>  })</span>
<span id="cb1-24"><a href="#cb1-24"></a>  </span>
<span id="cb1-25"><a href="#cb1-25"></a>  <span class="co"># calculate average value over isiccomb group for each country, year</span></span>
<span id="cb1-26"><a href="#cb1-26"></a>  interim<span class="sc">$</span>isiccomb.avg <span class="ot">&lt;-</span> </span>
<span id="cb1-27"><a href="#cb1-27"></a>    interim<span class="sc">$</span>isiccomb.rows <span class="sc">%&gt;%</span></span>
<span id="cb1-28"><a href="#cb1-28"></a>    <span class="co"># group isiccomb rows, replace na with 0 for averaging</span></span>
<span id="cb1-29"><a href="#cb1-29"></a>    <span class="fu">group_by</span>(country, year, isiccomb) <span class="sc">%&gt;%</span></span>
<span id="cb1-30"><a href="#cb1-30"></a>    <span class="fu">mutate</span>(<span class="at">value =</span> <span class="fu">replace_na</span>(value,<span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb1-31"><a href="#cb1-31"></a>    <span class="co"># split combination value over standard isic codes in isiccomb group</span></span>
<span id="cb1-32"><a href="#cb1-32"></a>    <span class="fu">summarise</span>(<span class="at">avg.value =</span> <span class="fu">mean</span>(value),</span>
<span id="cb1-33"><a href="#cb1-33"></a>              <span class="do">## checking variables</span></span>
<span id="cb1-34"><a href="#cb1-34"></a>              <span class="at">n_isic =</span> <span class="fu">n_distinct</span>(isic),</span>
<span id="cb1-35"><a href="#cb1-35"></a>              <span class="at">n_rows =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb1-36"><a href="#cb1-36"></a>    <span class="fu">mutate</span>(<span class="at">row_check =</span> (n_isic <span class="sc">==</span> n_rows))</span>
<span id="cb1-37"><a href="#cb1-37"></a>  </span>
<span id="cb1-38"><a href="#cb1-38"></a>  <span class="co">#  return(interim$isiccomb.avg)</span></span>
<span id="cb1-39"><a href="#cb1-39"></a>  </span>
<span id="cb1-40"><a href="#cb1-40"></a>  <span class="do">## check n_isic == n_rows</span></span>
<span id="cb1-41"><a href="#cb1-41"></a>  <span class="fu">test_that</span>(<span class="st">"isiccomb split average is calculated with correct denominator"</span>, {</span>
<span id="cb1-42"><a href="#cb1-42"></a>    <span class="fu">expect_true</span>(<span class="fu">all</span>(interim<span class="sc">$</span>isiccomb.avg<span class="sc">$</span>row_check))</span>
<span id="cb1-43"><a href="#cb1-43"></a>  })</span>
<span id="cb1-44"><a href="#cb1-44"></a>  </span>
<span id="cb1-45"><a href="#cb1-45"></a>  <span class="co"># output processed data</span></span>
<span id="cb1-46"><a href="#cb1-46"></a>  final <span class="ot">&lt;-</span></span>
<span id="cb1-47"><a href="#cb1-47"></a>    <span class="fu">left_join</span>(threefour_df, interim<span class="sc">$</span>isiccomb.avg, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">'country'</span>, <span class="st">'year'</span>, <span class="st">'isiccomb'</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb1-48"><a href="#cb1-48"></a>    <span class="fu">rename</span>(<span class="at">value.nosplit =</span> value) <span class="sc">%&gt;%</span></span>
<span id="cb1-49"><a href="#cb1-49"></a>    <span class="fu">mutate</span>(<span class="at">value =</span> <span class="fu">coalesce</span>(avg.value, value.nosplit),</span>
<span id="cb1-50"><a href="#cb1-50"></a>           <span class="at">split.isiccomb =</span> <span class="sc">!</span><span class="fu">is.na</span>(avg.value)) <span class="sc">%&gt;%</span></span>
<span id="cb1-51"><a href="#cb1-51"></a>    <span class="fu">select</span>(country, year, isic, isiccomb, value, value.nosplit, split.isiccomb) <span class="co"># not checking variables</span></span>
<span id="cb1-52"><a href="#cb1-52"></a>  </span>
<span id="cb1-53"><a href="#cb1-53"></a>  <span class="fu">return</span>(final)</span>
<span id="cb1-54"><a href="#cb1-54"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</section>
<section id="aside-on-discipline-silos" class="slide level2">
<h2>Aside on discipline silos</h2>
<div class="columns">
<div class="column smaller" style="width:50%;">
<blockquote>
<p>Of course, <strong>some desired integrations are simply unattainable.</strong> Consider changes to category schemas … the North American Industrial Classification System (NAICS) … replaced the previously used (and increasingly antiquated) Standard Industrial Code (SIC). The dramatic reorganization … leaves them nearly incomparable … <strong>Sometimes there is a limit to what one can wrangle. </strong><sup>1</sup></p>
</blockquote>
</div><div class="column" style="width:50%;">
<div class="fragment">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>schott_algorithm_28.do [800+ lines]</strong></pre>
</div>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource stata number-lines code-with-copy"><code class="sourceCode stata"><span id="cb2-1"><a href="#cb2-1"></a><span class="co">/*
</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="co">
</span></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="co">HS-SIC-NAICS- Concordance Project
</span></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="co">
</span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="co">This program
</span></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="co">
</span></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="co">	1. reads in the hs-sic and hs-naics concordances from the monthly trade cd files and
</span></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="co">         from Census and uses two mechanical matches to fill in naics matches prior to 2000 and sic 
</span></span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="co">         matches after 2001.
</span></span>
<span id="cb2-10"><a href="#cb2-10"></a><span class="co">	2. Although step 1 succeeds in generating many matches, there are some that remain unmatched. 
</span></span>
<span id="cb2-11"><a href="#cb2-11"></a><span class="co">         these were given to an RA (thanks kitjawat!) to match by hand. These hand matches are merged in 
</span></span>
<span id="cb2-12"><a href="#cb2-12"></a><span class="co">         after the mechanical matches. (Note that one typo in the handmatched file is fixed in this .do file.
</span></span>
<span id="cb2-13"><a href="#cb2-13"></a><span class="co">	3. In the future, we intend to explore using our hs-over-time concordances to avoid the need for any
</span></span>
<span id="cb2-14"><a href="#cb2-14"></a><span class="co">         hand-matching. 
</span></span>
<span id="cb2-15"><a href="#cb2-15"></a><span class="co">
</span></span>
<span id="cb2-16"><a href="#cb2-16"></a><span class="co">copyright Peter K. Schott / Justin R. Pierce
</span></span>
<span id="cb2-17"><a href="#cb2-17"></a><span class="co">
</span></span>
<span id="cb2-18"><a href="#cb2-18"></a><span class="co">This program, associated files and a working paper describing our overall HS-SIC-NAICS concordance effort 
</span></span>
<span id="cb2-19"><a href="#cb2-19"></a><span class="co">can be found at http://www.som.yale.edu/faculty/pks4/
</span></span>
<span id="cb2-20"><a href="#cb2-20"></a><span class="co">
</span></span>
<span id="cb2-21"><a href="#cb2-21"></a><span class="co">2008.08.21 first version
</span></span>
<span id="cb2-22"><a href="#cb2-22"></a><span class="co">2009.10.16 current version 
</span></span>
<span id="cb2-23"><a href="#cb2-23"></a><span class="co">2016.7.27  restored the older practice (89-106) of keeping SIC and naics codes as strings
</span></span>
<span id="cb2-24"><a href="#cb2-24"></a><span class="co">           so, in key place, subbed back in code from v20
</span></span>
<span id="cb2-25"><a href="#cb2-25"></a><span class="co">		   also updated to use concordances from 89-115
</span></span>
<span id="cb2-26"><a href="#cb2-26"></a><span class="co">2018.7.16  moved this all to /research/schott_trade_website
</span></span>
<span id="cb2-27"><a href="#cb2-27"></a><span class="co">		   added the NAICSX codes
</span></span>
<span id="cb2-28"><a href="#cb2-28"></a><span class="co">
</span></span>
<span id="cb2-29"><a href="#cb2-29"></a><span class="co">
</span></span>
<span id="cb2-30"><a href="#cb2-30"></a><span class="co">
</span></span>
<span id="cb2-31"><a href="#cb2-31"></a><span class="co">*/</span>
</span>
<span id="cb2-32"><a href="#cb2-32"></a>
</span>
<span id="cb2-33"><a href="#cb2-33"></a>
</span>
<span id="cb2-34"><a href="#cb2-34"></a>**0 Prelim
</span>
<span id="cb2-35"><a href="#cb2-35"></a>clear
</span>
<span id="cb2-36"><a href="#cb2-36"></a><span class="kw">set</span> <span class="kw">more</span> off
</span>
<span id="cb2-37"><a href="#cb2-37"></a>
</span>
<span id="cb2-38"><a href="#cb2-38"></a><span class="co">/*
</span></span>
<span id="cb2-39"><a href="#cb2-39"></a><span class="co">global MC "D:\Dropbox (yale som economics)\research\schott_trade_website\hs_sic_naics\input\m_concordance\"</span></span>
<span id="cb2-40"><a href="#cb2-40"></a><span class="co">global XC "D:\Dropbox (yale som economics)\research\schott_trade_website\hs_sic_naics\input\x_concordance\"</span></span>
<span id="cb2-41"><a href="#cb2-41"></a><span class="co">global NC "D:\Dropbox (yale som economics)\research\schott_trade_website\hs_sic_naics\input\naics\"</span></span>
<span id="cb2-42"><a href="#cb2-42"></a><span class="co">global C  "D:\Dropbox (yale som economics)\research\schott_trade_website\hs_sic_naics\"</span></span>
<span id="cb2-43"><a href="#cb2-43"></a><span class="co">global CI  "D:\Dropbox (yale som economics)\research\schott_trade_website\hs_sic_naics\interim"</span></span>
<span id="cb2-44"><a href="#cb2-44"></a><span class="co">*/</span>
</span>
<span id="cb2-45"><a href="#cb2-45"></a>
</span>
<span id="cb2-46"><a href="#cb2-46"></a>
</span>
<span id="cb2-47"><a href="#cb2-47"></a><span class="kw">global</span> MC <span class="st">"/io/jrp_research/schott_trade_website/hs_sic_naics/input/m_concordance/"</span>
</span>
<span id="cb2-48"><a href="#cb2-48"></a><span class="kw">global</span> XC <span class="st">"/io/jrp_research/schott_trade_website/hs_sic_naics/input/x_concordance/"</span>
</span>
<span id="cb2-49"><a href="#cb2-49"></a><span class="kw">global</span> NC <span class="st">"/io/jrp_research/schott_trade_website/hs_sic_naics/input/naics/"</span>
</span>
<span id="cb2-50"><a href="#cb2-50"></a><span class="kw">global</span> C  <span class="st">"/io/jrp_research/schott_trade_website/hs_sic_naics/"</span>
</span>
<span id="cb2-51"><a href="#cb2-51"></a><span class="kw">global</span> CI  <span class="st">"/io/jrp_research/schott_trade_website/hs_sic_naics/interim/"</span>
</span>
<span id="cb2-52"><a href="#cb2-52"></a>
</span>
<span id="cb2-53"><a href="#cb2-53"></a>cd <span class="st">"$C"</span>
</span>
<span id="cb2-54"><a href="#cb2-54"></a>
</span>
<span id="cb2-55"><a href="#cb2-55"></a>
</span>
<span id="cb2-56"><a href="#cb2-56"></a>
</span>
<span id="cb2-57"><a href="#cb2-57"></a>
</span>
<span id="cb2-58"><a href="#cb2-58"></a>*0 prep <span class="kw">new</span> (<span class="kw">post</span> 2016) concordances
</span>
<span id="cb2-59"><a href="#cb2-59"></a><span class="co">/*
</span></span>
<span id="cb2-60"><a href="#cb2-60"></a><span class="co">foreach y in "16" "17" {
</span></span>
<span id="cb2-61"><a href="#cb2-61"></a><span class="co">	foreach m in "12" /*"01" "02" "03" "04" "05" "06" "07" "08" "09" "10" "11" "12"*/</span> {
</span>
<span id="cb2-62"><a href="#cb2-62"></a>	
</span>
<span id="cb2-63"><a href="#cb2-63"></a>		cd <span class="kw">d</span>:\<span class="kw">data</span>\raw_yale_trade\monthly
</span>
<span id="cb2-64"><a href="#cb2-64"></a>		unzipfile EXDB<span class="ot">`y'`m'</span>, replace
</span>
<span id="cb2-65"><a href="#cb2-65"></a>
</span>
<span id="cb2-66"><a href="#cb2-66"></a>		infix <span class="co">///
</span></span>
<span id="cb2-67"><a href="#cb2-67"></a>			<span class="kw">double</span> commodity 	1-10 <span class="co">///
</span></span>
<span id="cb2-68"><a href="#cb2-68"></a>			str descrip_1 		11-160 <span class="co">///
</span></span>
<span id="cb2-69"><a href="#cb2-69"></a>			str descrip_2 		161-210 <span class="co">///
</span></span>
<span id="cb2-70"><a href="#cb2-70"></a>			str quantity_1 		211-213 <span class="co">///
</span></span>
<span id="cb2-71"><a href="#cb2-71"></a>			str quantity_2 		214-216 <span class="co">///
</span></span>
<span id="cb2-72"><a href="#cb2-72"></a>			<span class="kw">double</span> sitc 		217-221 <span class="co">///
</span></span>
<span id="cb2-73"><a href="#cb2-73"></a>			<span class="kw">double</span> end_use 		222-226 <span class="co">///
</span></span>
<span id="cb2-74"><a href="#cb2-74"></a>			str naics			227-232 <span class="co">///
</span></span>
<span id="cb2-75"><a href="#cb2-75"></a>			usda				233-233 <span class="co">///
</span></span>
<span id="cb2-76"><a href="#cb2-76"></a>			hitech				234-235 <span class="co">///
</span></span>
<span id="cb2-77"><a href="#cb2-77"></a>		<span class="kw">using</span> CONCORD.TXT, clear
</span>
<span id="cb2-78"><a href="#cb2-78"></a>		
</span>
<span id="cb2-79"><a href="#cb2-79"></a>		<span class="kw">label</span> <span class="kw">var</span> commodity 	<span class="st">"10-Digit Harmonized Tariff Schedule (HTS) Code"</span>
</span>
<span id="cb2-80"><a href="#cb2-80"></a>		<span class="kw">label</span> <span class="kw">var</span> descrip_1		<span class="st">"150 digit description"</span>
</span>
<span id="cb2-81"><a href="#cb2-81"></a>		<span class="kw">label</span> <span class="kw">var</span> descrip_2		<span class="st">"50 digit description"</span>
</span>
<span id="cb2-82"><a href="#cb2-82"></a>		<span class="kw">label</span> <span class="kw">var</span> quantity_1	<span class="st">"3-digit unit of q 1"</span>
</span>
<span id="cb2-83"><a href="#cb2-83"></a>		<span class="kw">label</span> <span class="kw">var</span> quantity_2	<span class="st">"3-digit unit of q 1"</span>
</span>
<span id="cb2-84"><a href="#cb2-84"></a>
</span>
<span id="cb2-85"><a href="#cb2-85"></a>		cd <span class="st">"$XC"</span>
</span>
<span id="cb2-86"><a href="#cb2-86"></a>		<span class="kw">save</span> concord_1<span class="ot">`y'</span>, replace
</span>
<span id="cb2-87"><a href="#cb2-87"></a>	}
</span>
<span id="cb2-88"><a href="#cb2-88"></a>}
</span>
<span id="cb2-89"><a href="#cb2-89"></a><span class="kw">foreach</span> <span class="fu">y</span> <span class="kw">in</span> <span class="st">"16"</span> <span class="st">"17"</span> {
</span>
<span id="cb2-90"><a href="#cb2-90"></a>	<span class="kw">foreach</span> <span class="fu">m</span> <span class="kw">in</span> <span class="st">"12"</span> <span class="co">/*"01" "02" "03" "04" "05" "06" "07" "08" "09" "10" "11" "12"*/</span> {
</span>
<span id="cb2-91"><a href="#cb2-91"></a>	
</span>
<span id="cb2-92"><a href="#cb2-92"></a>		cd <span class="kw">d</span>:\<span class="kw">data</span>\raw_yale_trade\monthly
</span>
<span id="cb2-93"><a href="#cb2-93"></a>		unzipfile IMDB<span class="ot">`y'`m'</span>, replace
</span>
<span id="cb2-94"><a href="#cb2-94"></a>
</span>
<span id="cb2-95"><a href="#cb2-95"></a>		infix <span class="co">///
</span></span>
<span id="cb2-96"><a href="#cb2-96"></a>			<span class="kw">double</span> commodity 	1-10 <span class="co">///
</span></span>
<span id="cb2-97"><a href="#cb2-97"></a>			str descrip_1 		11-160 <span class="co">///
</span></span>
<span id="cb2-98"><a href="#cb2-98"></a>			str descrip_2 		161-210 <span class="co">///
</span></span>
<span id="cb2-99"><a href="#cb2-99"></a>			str quantity_1 		211-213 <span class="co">///
</span></span>
<span id="cb2-100"><a href="#cb2-100"></a>			str quantity_2 		214-216 <span class="co">///
</span></span>
<span id="cb2-101"><a href="#cb2-101"></a>			<span class="kw">double</span> sitc 		217-221 <span class="co">///
</span></span>
<span id="cb2-102"><a href="#cb2-102"></a>			<span class="kw">double</span> end_use 		222-226 <span class="co">///
</span></span>
<span id="cb2-103"><a href="#cb2-103"></a>			str naics			227-232 <span class="co">///
</span></span>
<span id="cb2-104"><a href="#cb2-104"></a>			usda				233-233 <span class="co">///
</span></span>
<span id="cb2-105"><a href="#cb2-105"></a>			hitech				234-235 <span class="co">///
</span></span>
<span id="cb2-106"><a href="#cb2-106"></a>		<span class="kw">using</span> CONCORD.TXT, clear
</span>
<span id="cb2-107"><a href="#cb2-107"></a>		
</span>
<span id="cb2-108"><a href="#cb2-108"></a>		<span class="kw">label</span> <span class="kw">var</span> commodity 	<span class="st">"10-Digit Harmonized Tariff Schedule (HTS) Code"</span>
</span>
<span id="cb2-109"><a href="#cb2-109"></a>		<span class="kw">label</span> <span class="kw">var</span> descrip_1		<span class="st">"150 digit description"</span>
</span>
<span id="cb2-110"><a href="#cb2-110"></a>		<span class="kw">label</span> <span class="kw">var</span> descrip_2		<span class="st">"50 digit description"</span>
</span>
<span id="cb2-111"><a href="#cb2-111"></a>		<span class="kw">label</span> <span class="kw">var</span> quantity_1	<span class="st">"3-digit unit of q 1"</span>
</span>
<span id="cb2-112"><a href="#cb2-112"></a>		<span class="kw">label</span> <span class="kw">var</span> quantity_2	<span class="st">"3-digit unit of q 1"</span>
</span>
<span id="cb2-113"><a href="#cb2-113"></a>
</span>
<span id="cb2-114"><a href="#cb2-114"></a>		cd <span class="st">"$MC"</span>
</span>
<span id="cb2-115"><a href="#cb2-115"></a>		<span class="kw">save</span> concord_20<span class="ot">`y'</span>, replace
</span>
<span id="cb2-116"><a href="#cb2-116"></a>	}
</span>
<span id="cb2-117"><a href="#cb2-117"></a>}
</span>
<span id="cb2-118"><a href="#cb2-118"></a>*/
</span>
<span id="cb2-119"><a href="#cb2-119"></a>
</span>
<span id="cb2-120"><a href="#cb2-120"></a>
</span>
<span id="cb2-121"><a href="#cb2-121"></a>
</span>
<span id="cb2-122"><a href="#cb2-122"></a>
</span>
<span id="cb2-123"><a href="#cb2-123"></a>
</span>
<span id="cb2-124"><a href="#cb2-124"></a>
</span>
<span id="cb2-125"><a href="#cb2-125"></a>
</span>
<span id="cb2-126"><a href="#cb2-126"></a>**1 Assemble the concordance files from the Census trade
</span>
<span id="cb2-127"><a href="#cb2-127"></a>*files <span class="kw">for</span> the years 1989-2017
</span>
<span id="cb2-128"><a href="#cb2-128"></a>
</span>
<span id="cb2-129"><a href="#cb2-129"></a>*1.1 Imports
</span>
<span id="cb2-130"><a href="#cb2-130"></a>cd <span class="st">"$MC"</span>
</span>
<span id="cb2-131"><a href="#cb2-131"></a><span class="kw">use</span> concord_1989, clear
</span>
<span id="cb2-132"><a href="#cb2-132"></a><span class="kw">gen</span> <span class="fu">year</span>=1989
</span>
<span id="cb2-133"><a href="#cb2-133"></a><span class="kw">forvalues</span> <span class="fu">y</span>=1990/2017 {
</span>
<span id="cb2-134"><a href="#cb2-134"></a>	<span class="kw">display</span>[<span class="st">"`y'"</span>]
</span>
<span id="cb2-135"><a href="#cb2-135"></a>
</span>
<span id="cb2-136"><a href="#cb2-136"></a>	<span class="kw">append</span> <span class="kw">using</span> concord_<span class="ot">`y'</span>
</span>
<span id="cb2-137"><a href="#cb2-137"></a>	
</span>
<span id="cb2-138"><a href="#cb2-138"></a>	<span class="kw">replace</span> <span class="fu">year</span>=<span class="ot">`y'</span> <span class="kw">if</span> <span class="fu">year</span>==.
</span>
<span id="cb2-139"><a href="#cb2-139"></a>	
</span>
<span id="cb2-140"><a href="#cb2-140"></a>	<span class="kw">if</span> <span class="ot">`y'</span> &lt;2000 {
</span>
<span id="cb2-141"><a href="#cb2-141"></a>		<span class="kw">keep</span> commodity <span class="fu">year</span> sic 
</span>
<span id="cb2-142"><a href="#cb2-142"></a>	}
</span>
<span id="cb2-143"><a href="#cb2-143"></a>	<span class="kw">if</span> <span class="ot">`y'</span> &gt;=2000 {
</span>
<span id="cb2-144"><a href="#cb2-144"></a>		<span class="kw">keep</span> commodity <span class="fu">year</span> naics sic
</span>
<span id="cb2-145"><a href="#cb2-145"></a>	}
</span>
<span id="cb2-146"><a href="#cb2-146"></a>	<span class="kw">if</span> <span class="ot">`y'</span>==2005 {
</span>
<span id="cb2-147"><a href="#cb2-147"></a>		<span class="kw">rename</span> commodity scommodity
</span>
<span id="cb2-148"><a href="#cb2-148"></a>		<span class="kw">destring</span> scommodity, <span class="kw">force</span> g(commodity)
</span>
<span id="cb2-149"><a href="#cb2-149"></a>	}
</span>
<span id="cb2-150"><a href="#cb2-150"></a>}
</span>
<span id="cb2-151"><a href="#cb2-151"></a>cd <span class="st">"$CI"</span>
</span>
<span id="cb2-152"><a href="#cb2-152"></a><span class="kw">duplicates</span> drop
</span>
<span id="cb2-153"><a href="#cb2-153"></a><span class="kw">save</span> concord_m_1989_2017_abbreviated, replace
</span>
<span id="cb2-154"><a href="#cb2-154"></a>
</span>
<span id="cb2-155"><a href="#cb2-155"></a>*Check number <span class="kw">of</span> manufacturing codes
</span>
<span id="cb2-156"><a href="#cb2-156"></a><span class="kw">use</span> concord_m_1989_2017_abbreviated, clear
</span>
<span id="cb2-157"><a href="#cb2-157"></a><span class="kw">gen</span> man =<span class="fu">substr</span>(naics,1,1)==<span class="st">"3"</span>
</span>
<span id="cb2-158"><a href="#cb2-158"></a><span class="kw">egen</span> x = <span class="fu">tag</span>(naics <span class="fu">year</span>)
</span>
<span id="cb2-159"><a href="#cb2-159"></a><span class="kw">table</span> <span class="fu">year</span> <span class="kw">if</span> x, c(<span class="kw">sum</span> man)
</span>
<span id="cb2-160"><a href="#cb2-160"></a>
</span>
<span id="cb2-161"><a href="#cb2-161"></a>*1.2 Exports
</span>
<span id="cb2-162"><a href="#cb2-162"></a>cd <span class="st">"$XC"</span>
</span>
<span id="cb2-163"><a href="#cb2-163"></a><span class="kw">use</span> concord_89, clear
</span>
<span id="cb2-164"><a href="#cb2-164"></a><span class="kw">gen</span> <span class="fu">year</span>=89
</span>
<span id="cb2-165"><a href="#cb2-165"></a><span class="kw">forvalues</span> <span class="fu">y</span>=90/117 {
</span>
<span id="cb2-166"><a href="#cb2-166"></a>	<span class="kw">display</span>[<span class="st">"`y'"</span>]
</span>
<span id="cb2-167"><a href="#cb2-167"></a>	<span class="kw">append</span> <span class="kw">using</span> concord_<span class="ot">`y'</span>
</span>
<span id="cb2-168"><a href="#cb2-168"></a>	<span class="kw">replace</span> <span class="fu">year</span>=<span class="ot">`y'</span> <span class="kw">if</span> <span class="fu">year</span>==.
</span>
<span id="cb2-169"><a href="#cb2-169"></a>	*Note that NAICS codes are <span class="kw">not</span> reported <span class="kw">until</span> 2000
</span>
<span id="cb2-170"><a href="#cb2-170"></a>	<span class="kw">if</span> <span class="ot">`y'</span> &lt;100 {
</span>
<span id="cb2-171"><a href="#cb2-171"></a>		<span class="kw">keep</span> commodity <span class="fu">year</span> sic
</span>
<span id="cb2-172"><a href="#cb2-172"></a>	}
</span>
<span id="cb2-173"><a href="#cb2-173"></a>	<span class="kw">if</span> <span class="ot">`y'</span> &gt;=100 &amp; <span class="ot">`y'</span>&lt;=106 {
</span>
<span id="cb2-174"><a href="#cb2-174"></a>		<span class="kw">keep</span> commodity <span class="fu">year</span> naics sic
</span>
<span id="cb2-175"><a href="#cb2-175"></a>	}
</span>
<span id="cb2-176"><a href="#cb2-176"></a>	<span class="kw">if</span> <span class="ot">`y'</span>==106 {
</span>
<span id="cb2-177"><a href="#cb2-177"></a>		<span class="kw">rename</span> commodity scommodity
</span>
<span id="cb2-178"><a href="#cb2-178"></a>		<span class="kw">destring</span> scommodity, <span class="kw">force</span> g(commodity)
</span>
<span id="cb2-179"><a href="#cb2-179"></a>		<span class="kw">rename</span> sic ssic
</span>
<span id="cb2-180"><a href="#cb2-180"></a>	}	
</span>
<span id="cb2-181"><a href="#cb2-181"></a>	<span class="kw">if</span> <span class="ot">`y'</span> &gt;106 {
</span>
<span id="cb2-182"><a href="#cb2-182"></a>		<span class="kw">keep</span> commodity <span class="fu">year</span> naics sic ssic
</span>
<span id="cb2-183"><a href="#cb2-183"></a>	}
</span>
<span id="cb2-184"><a href="#cb2-184"></a>}
</span>
<span id="cb2-185"><a href="#cb2-185"></a><span class="kw">drop</span> sic
</span>
<span id="cb2-186"><a href="#cb2-186"></a><span class="kw">rename</span> ssic sic
</span>
<span id="cb2-187"><a href="#cb2-187"></a><span class="kw">replace</span> <span class="fu">year</span>=<span class="fu">year</span>+1900
</span>
<span id="cb2-188"><a href="#cb2-188"></a>cd <span class="st">"$CI"</span>
</span>
<span id="cb2-189"><a href="#cb2-189"></a><span class="kw">duplicates</span> drop
</span>
<span id="cb2-190"><a href="#cb2-190"></a><span class="kw">save</span> concord_x_1989_2017_abbreviated, replace
</span>
<span id="cb2-191"><a href="#cb2-191"></a>
</span>
<span id="cb2-192"><a href="#cb2-192"></a>*check # man codes
</span>
<span id="cb2-193"><a href="#cb2-193"></a>*
</span>
<span id="cb2-194"><a href="#cb2-194"></a>*	Dip <span class="kw">in</span> 2013 due to implementation <span class="kw">of</span> NAICS 2012
</span>
<span id="cb2-195"><a href="#cb2-195"></a>*
</span>
<span id="cb2-196"><a href="#cb2-196"></a>*	But why recovery (somewhat) starting <span class="kw">in</span> 2014
</span>
<span id="cb2-197"><a href="#cb2-197"></a>*
</span>
<span id="cb2-198"><a href="#cb2-198"></a><span class="kw">use</span> concord_x_1989_2017_abbreviated, clear
</span>
<span id="cb2-199"><a href="#cb2-199"></a><span class="kw">gen</span> man =<span class="fu">substr</span>(naics,1,1)==<span class="st">"3"</span>
</span>
<span id="cb2-200"><a href="#cb2-200"></a><span class="kw">egen</span> x = <span class="fu">tag</span>(naics <span class="fu">year</span>)
</span>
<span id="cb2-201"><a href="#cb2-201"></a><span class="kw">table</span> <span class="fu">year</span> <span class="kw">if</span> x, c(<span class="kw">sum</span> man)
</span>
<span id="cb2-202"><a href="#cb2-202"></a>
</span>
<span id="cb2-203"><a href="#cb2-203"></a>
</span>
<span id="cb2-204"><a href="#cb2-204"></a>
</span>
<span id="cb2-205"><a href="#cb2-205"></a>
</span>
<span id="cb2-206"><a href="#cb2-206"></a>**2 SIC Mapping 
</span>
<span id="cb2-207"><a href="#cb2-207"></a>*Assigns SIC codes to HS codes <span class="kw">for</span> years after <span class="kw">end</span> <span class="kw">of</span> SIC
</span>
<span id="cb2-208"><a href="#cb2-208"></a>
</span>
<span id="cb2-209"><a href="#cb2-209"></a>cd <span class="st">"$CI"</span>
</span>
<span id="cb2-210"><a href="#cb2-210"></a><span class="kw">foreach</span> zzz <span class="kw">in</span> x <span class="fu">m</span> {
</span>
<span id="cb2-211"><a href="#cb2-211"></a>
</span>
<span id="cb2-212"><a href="#cb2-212"></a>	*Create <span class="ot">list</span> <span class="kw">of</span> HS-SIC mappings <span class="kw">for</span> 2001
</span>
<span id="cb2-213"><a href="#cb2-213"></a>	*(<span class="fu">last</span> <span class="fu">year</span> <span class="kw">for</span> which sic <span class="kw">data</span> are available)
</span>
<span id="cb2-214"><a href="#cb2-214"></a>	<span class="kw">use</span> concord_<span class="ot">`zzz'</span>_1989_2017_abbreviated, clear
</span>
<span id="cb2-215"><a href="#cb2-215"></a>	<span class="kw">replace</span> <span class="fu">year</span>=<span class="fu">year</span>-1900
</span>
<span id="cb2-216"><a href="#cb2-216"></a>	<span class="kw">keep</span> <span class="kw">if</span> <span class="fu">year</span>==101
</span>
<span id="cb2-217"><a href="#cb2-217"></a>	<span class="kw">keep</span> commodity sic
</span>
<span id="cb2-218"><a href="#cb2-218"></a>	<span class="kw">drop</span> <span class="kw">if</span> sic==<span class="st">""</span>
</span>
<span id="cb2-219"><a href="#cb2-219"></a>	<span class="kw">duplicates</span> <span class="kw">drop</span> commodity, <span class="kw">force</span> 
</span>
<span id="cb2-220"><a href="#cb2-220"></a>	<span class="kw">sort</span> commodity
</span>
<span id="cb2-221"><a href="#cb2-221"></a>	<span class="kw">save</span> <span class="ot">`zzz'</span>temp0, replace
</span>
<span id="cb2-222"><a href="#cb2-222"></a>	
</span>
<span id="cb2-223"><a href="#cb2-223"></a>	*Match <span class="ot">list</span> <span class="kw">of</span> 2001 HS-SIC mappings to <span class="kw">post</span>-2001 years
</span>
<span id="cb2-224"><a href="#cb2-224"></a>	<span class="kw">use</span> concord_<span class="ot">`zzz'</span>_1989_2017_abbreviated, clear
</span>
<span id="cb2-225"><a href="#cb2-225"></a>	<span class="kw">replace</span> <span class="fu">year</span>=<span class="fu">year</span>-1900
</span>
<span id="cb2-226"><a href="#cb2-226"></a>	<span class="kw">keep</span> <span class="kw">if</span> <span class="fu">year</span>&gt;101
</span>
<span id="cb2-227"><a href="#cb2-227"></a>	<span class="kw">keep</span> commodity
</span>
<span id="cb2-228"><a href="#cb2-228"></a>	<span class="kw">duplicates</span> <span class="kw">drop</span> commodity, force
</span>
<span id="cb2-229"><a href="#cb2-229"></a>	<span class="kw">sort</span> commodity
</span>
<span id="cb2-230"><a href="#cb2-230"></a>	<span class="kw">merge</span> commodity <span class="kw">using</span> <span class="ot">`zzz'</span>temp0, <span class="kw">keep</span>(sic) 
</span>
<span id="cb2-231"><a href="#cb2-231"></a>	<span class="kw">tab</span> _merge
</span>
<span id="cb2-232"><a href="#cb2-232"></a>	<span class="kw">drop</span> _merge
</span>
<span id="cb2-233"><a href="#cb2-233"></a>	<span class="kw">gen</span> <span class="kw">double</span> hs=commodity
</span>
<span id="cb2-234"><a href="#cb2-234"></a>	<span class="kw">format</span> hs %15.0fc
</span>
<span id="cb2-235"><a href="#cb2-235"></a>	<span class="kw">egen</span> sic87=<span class="fu">group</span>(sic)
</span>
<span id="cb2-236"><a href="#cb2-236"></a>	<span class="kw">save</span> <span class="ot">`zzz'</span>temp_01, replace
</span>
<span id="cb2-237"><a href="#cb2-237"></a>
</span>
<span id="cb2-238"><a href="#cb2-238"></a>	*Save <span class="kw">two</span> versions <span class="kw">of</span> <span class="fu">group</span>-naics mapping <span class="kw">for</span> below.
</span>
<span id="cb2-239"><a href="#cb2-239"></a>	*These are simply used <span class="kw">for</span> labeling the source of
</span>
<span id="cb2-240"><a href="#cb2-240"></a>	*HS-SIC matches.
</span>
<span id="cb2-241"><a href="#cb2-241"></a>	<span class="kw">use</span> <span class="ot">`zzz'</span>temp_01, clear
</span>
<span id="cb2-242"><a href="#cb2-242"></a>	<span class="kw">collapse</span> (<span class="kw">mean</span>) sic87, <span class="kw">by</span>(sic)
</span>
<span id="cb2-243"><a href="#cb2-243"></a>	<span class="kw">rename</span> sic87 sic87_new1
</span>
<span id="cb2-244"><a href="#cb2-244"></a>	<span class="kw">rename</span> sic sic_new1
</span>
<span id="cb2-245"><a href="#cb2-245"></a>	<span class="kw">drop</span> <span class="kw">if</span> sic_new1==<span class="st">""</span> | sic87_new1==.
</span>
<span id="cb2-246"><a href="#cb2-246"></a>	<span class="kw">sort</span> sic87_new1
</span>
<span id="cb2-247"><a href="#cb2-247"></a>	<span class="kw">save</span> <span class="ot">`zzz'</span>temp1, replace
</span>
<span id="cb2-248"><a href="#cb2-248"></a>	
</span>
<span id="cb2-249"><a href="#cb2-249"></a>	<span class="kw">use</span> <span class="ot">`zzz'</span>temp_01, clear
</span>
<span id="cb2-250"><a href="#cb2-250"></a>	<span class="kw">collapse</span> (<span class="kw">mean</span>) sic87, <span class="kw">by</span>(sic)
</span>
<span id="cb2-251"><a href="#cb2-251"></a>	<span class="kw">rename</span> sic87 sic87_new2
</span>
<span id="cb2-252"><a href="#cb2-252"></a>	<span class="kw">rename</span> sic sic_new2
</span>
<span id="cb2-253"><a href="#cb2-253"></a>	<span class="kw">drop</span> <span class="kw">if</span> sic_new2==<span class="st">""</span> | sic87_new2==.
</span>
<span id="cb2-254"><a href="#cb2-254"></a>	<span class="kw">sort</span> sic87_new2
</span>
<span id="cb2-255"><a href="#cb2-255"></a>	<span class="kw">save</span> <span class="ot">`zzz'</span>temp2, replace
</span>
<span id="cb2-256"><a href="#cb2-256"></a>
</span>
<span id="cb2-257"><a href="#cb2-257"></a>	*First Mechanical Match
</span>
<span id="cb2-258"><a href="#cb2-258"></a>	*Look <span class="fu">at</span> SIC matches <span class="kw">for</span> HS10s within an HS9.  If <span class="ot">all</span> non-missing
</span>
<span id="cb2-259"><a href="#cb2-259"></a>	*SIC codes are the same, assign that SIC code to unmatched HS10s within
</span>
<span id="cb2-260"><a href="#cb2-260"></a>	*that HS9.  Repeat <span class="kw">for</span> higher <span class="kw">levels</span> <span class="kw">of</span> aggregation.
</span>
<span id="cb2-261"><a href="#cb2-261"></a>	<span class="kw">use</span> <span class="ot">`zzz'</span>temp_01, clear
</span>
<span id="cb2-262"><a href="#cb2-262"></a>	<span class="kw">gen</span> sic87_new1 = sic87
</span>
<span id="cb2-263"><a href="#cb2-263"></a>	<span class="kw">sum</span> hs sic87*
</span>
<span id="cb2-264"><a href="#cb2-264"></a>	<span class="kw">quietly</span> {
</span>
<span id="cb2-265"><a href="#cb2-265"></a>	  <span class="kw">foreach</span> x <span class="kw">in</span> 9 8 7 6 5 4 3 2 {
</span>
<span id="cb2-266"><a href="#cb2-266"></a>		<span class="kw">noisily</span> <span class="kw">display</span> [<span class="ot">`x'</span>]
</span>
<span id="cb2-267"><a href="#cb2-267"></a>		<span class="kw">local</span> <span class="fu">y</span>       = 10-<span class="ot">`x'</span>
</span>
<span id="cb2-268"><a href="#cb2-268"></a>		<span class="kw">gen</span> hs<span class="ot">`x'</span>     = <span class="kw">int</span>(hs/(10^<span class="ot">`y'</span>))
</span>
<span id="cb2-269"><a href="#cb2-269"></a>		<span class="kw">egen</span> t1       = <span class="kw">mean</span>(sic87), <span class="kw">by</span>(hs<span class="ot">`x'</span>)
</span>
<span id="cb2-270"><a href="#cb2-270"></a>		<span class="kw">egen</span> t2       = <span class="fu">sd</span>(sic87), <span class="kw">by</span>(hs<span class="ot">`x'</span>)
</span>
<span id="cb2-271"><a href="#cb2-271"></a>		<span class="kw">egen</span> t3       = <span class="fu">count</span>(sic87), <span class="kw">by</span>(hs<span class="ot">`x'</span>)
</span>
<span id="cb2-272"><a href="#cb2-272"></a>		<span class="kw">gen</span> sic87_<span class="ot">`x'</span> = t1 <span class="kw">if</span> t2==0 | t3==1
</span>
<span id="cb2-273"><a href="#cb2-273"></a>		<span class="kw">replace</span> sic87_new1 = sic87_<span class="ot">`x'</span> <span class="kw">if</span> sic87==. &amp; sic87_new1==.
</span>
<span id="cb2-274"><a href="#cb2-274"></a>		<span class="kw">drop</span> t1 t2 t3
</span>
<span id="cb2-275"><a href="#cb2-275"></a>		<span class="kw">drop</span> hs<span class="ot">`x'</span> sic87_<span class="ot">`x'</span>
</span>
<span id="cb2-276"><a href="#cb2-276"></a>	  } 
</span>
<span id="cb2-277"><a href="#cb2-277"></a>	}
</span>
<span id="cb2-278"><a href="#cb2-278"></a>	<span class="kw">sum</span> hs sic87 sic87_new1
</span>
<span id="cb2-279"><a href="#cb2-279"></a>	<span class="kw">sort</span> hs
</span>
<span id="cb2-280"><a href="#cb2-280"></a>	<span class="kw">save</span> <span class="ot">`zzz'</span>temp_02, replace
</span>
<span id="cb2-281"><a href="#cb2-281"></a>	
</span>
<span id="cb2-282"><a href="#cb2-282"></a>	*Second Mechanical Match
</span>
<span id="cb2-283"><a href="#cb2-283"></a>	*Sort HS codes.  For unmatched HS codes (<span class="kw">or</span> contiguous groups <span class="kw">of</span> HS10
</span>
<span id="cb2-284"><a href="#cb2-284"></a>	*codes), look <span class="fu">at</span> the matched HS10 codes that precede and follow.  If
</span>
<span id="cb2-285"><a href="#cb2-285"></a>	*matches <span class="kw">for</span> preceding and following HS10 codes are identical, assign
</span>
<span id="cb2-286"><a href="#cb2-286"></a>	*that SIC code to the unmatched HS code(<span class="fu">s</span>).
</span>
<span id="cb2-287"><a href="#cb2-287"></a>	<span class="kw">use</span> <span class="ot">`zzz'</span>temp_02, clear
</span>
<span id="cb2-288"><a href="#cb2-288"></a>	<span class="kw">gen</span> sic87_new2 = sic87_new1
</span>
<span id="cb2-289"><a href="#cb2-289"></a>	<span class="kw">gen</span> <span class="kw">begin</span>      = 1 <span class="kw">if</span> sic87_new1==. &amp; sic87_new1[<span class="dt">_n</span>-1]~=.
</span>
<span id="cb2-290"><a href="#cb2-290"></a>	<span class="kw">gen</span> <span class="kw">end</span>        = sic87_new1==. &amp; sic87_new1[<span class="dt">_n</span>+1]~=.
</span>
<span id="cb2-291"><a href="#cb2-291"></a>	<span class="kw">gen</span> bsum       = <span class="kw">sum</span>(<span class="kw">begin</span>)
</span>
<span id="cb2-292"><a href="#cb2-292"></a>	<span class="kw">gen</span> gap        = sic87_new1==.
</span>
<span id="cb2-293"><a href="#cb2-293"></a>	<span class="kw">replace</span> bsum=. <span class="kw">if</span> gap==0
</span>
<span id="cb2-294"><a href="#cb2-294"></a>	<span class="kw">gen</span> sb         = sic87_new1[<span class="dt">_n</span>-1]*begin
</span>
<span id="cb2-295"><a href="#cb2-295"></a>	<span class="kw">gen</span> se         = sic87_new1[<span class="dt">_n</span>+1]*end
</span>
<span id="cb2-296"><a href="#cb2-296"></a>	<span class="kw">egen</span> tb        = <span class="kw">mean</span>(sb), <span class="kw">by</span>(bsum)
</span>
<span id="cb2-297"><a href="#cb2-297"></a>	<span class="kw">egen</span> <span class="kw">te</span>        = <span class="kw">mean</span>(se), <span class="kw">by</span>(bsum)
</span>
<span id="cb2-298"><a href="#cb2-298"></a>	<span class="kw">gen</span> <span class="fu">match</span>      = tb==te
</span>
<span id="cb2-299"><a href="#cb2-299"></a>	<span class="kw">replace</span> sic87_new2 = tb <span class="kw">if</span> <span class="fu">match</span>==1 &amp; sic87_new1==.
</span>
<span id="cb2-300"><a href="#cb2-300"></a>	<span class="kw">sum</span> hs sic87*
</span>
<span id="cb2-301"><a href="#cb2-301"></a>	<span class="kw">drop</span> <span class="kw">begin</span> <span class="kw">end</span> bsum gap sb se tb <span class="kw">te</span> match
</span>
<span id="cb2-302"><a href="#cb2-302"></a>	<span class="kw">sort</span> hs
</span>
<span id="cb2-303"><a href="#cb2-303"></a>	<span class="kw">save</span> <span class="ot">`zzz'</span>temp_03, replace
</span>
<span id="cb2-304"><a href="#cb2-304"></a>	
</span>
<span id="cb2-305"><a href="#cb2-305"></a>	*Merge <span class="kw">in</span> <span class="st">"group"</span> codes created above, which are only used <span class="kw">for</span> labeling.
</span>
<span id="cb2-306"><a href="#cb2-306"></a>	<span class="kw">use</span> <span class="ot">`zzz'</span>temp_03, clear
</span>
<span id="cb2-307"><a href="#cb2-307"></a>	<span class="kw">sort</span> sic87_new1
</span>
<span id="cb2-308"><a href="#cb2-308"></a>	<span class="kw">merge</span> sic87_new1 <span class="kw">using</span> <span class="ot">`zzz'</span>temp1, <span class="kw">keep</span>(sic_new1)
</span>
<span id="cb2-309"><a href="#cb2-309"></a>	<span class="kw">tab</span> _merge
</span>
<span id="cb2-310"><a href="#cb2-310"></a>	<span class="kw">drop</span> _merge
</span>
<span id="cb2-311"><a href="#cb2-311"></a>	<span class="kw">sort</span> sic87_new2
</span>
<span id="cb2-312"><a href="#cb2-312"></a>	<span class="kw">merge</span> sic87_new2 <span class="kw">using</span> <span class="ot">`zzz'</span>temp2, <span class="kw">keep</span>(sic_new2)
</span>
<span id="cb2-313"><a href="#cb2-313"></a>	<span class="kw">tab</span> _merge
</span>
<span id="cb2-314"><a href="#cb2-314"></a>	<span class="kw">drop</span> _merge
</span>
<span id="cb2-315"><a href="#cb2-315"></a>	<span class="kw">sort</span> hs
</span>
<span id="cb2-316"><a href="#cb2-316"></a>	<span class="kw">gen</span> t=sic87_new1~=.
</span>
<span id="cb2-317"><a href="#cb2-317"></a>	<span class="kw">tab</span> t
</span>
<span id="cb2-318"><a href="#cb2-318"></a>	<span class="kw">drop</span> t 
</span>
<span id="cb2-319"><a href="#cb2-319"></a>      <span class="kw">drop</span> sic87*
</span>
<span id="cb2-320"><a href="#cb2-320"></a>	<span class="kw">format</span> hs %15.0g
</span>
<span id="cb2-321"><a href="#cb2-321"></a>	<span class="kw">drop</span> <span class="kw">if</span> hs&lt;100
</span>
<span id="cb2-322"><a href="#cb2-322"></a>	<span class="kw">format</span> commodity %15.0fc
</span>
<span id="cb2-323"><a href="#cb2-323"></a>	<span class="kw">save</span> <span class="ot">`zzz'</span>_concord_89_117_sicfillin, replace
</span>
<span id="cb2-324"><a href="#cb2-324"></a>}
</span>
<span id="cb2-325"><a href="#cb2-325"></a>
</span>
<span id="cb2-326"><a href="#cb2-326"></a>
</span>
<span id="cb2-327"><a href="#cb2-327"></a>
</span>
<span id="cb2-328"><a href="#cb2-328"></a>**2 NAICS
</span>
<span id="cb2-329"><a href="#cb2-329"></a>*Assigns NAICS codes to HS codes <span class="kw">for</span> years before <span class="bn">start</span> <span class="kw">of</span> NAICS
</span>
<span id="cb2-330"><a href="#cb2-330"></a>
</span>
<span id="cb2-331"><a href="#cb2-331"></a>cd <span class="st">"$CI"</span>
</span>
<span id="cb2-332"><a href="#cb2-332"></a><span class="kw">foreach</span> zzz <span class="kw">in</span> x <span class="fu">m</span> {
</span>
<span id="cb2-333"><a href="#cb2-333"></a>
</span>
<span id="cb2-334"><a href="#cb2-334"></a>	*Create <span class="ot">list</span> <span class="kw">of</span> HS-NAICS mappings <span class="kw">for</span> 2000
</span>
<span id="cb2-335"><a href="#cb2-335"></a>	*(first <span class="fu">year</span> <span class="kw">for</span> which naics <span class="kw">data</span> are available)
</span>
<span id="cb2-336"><a href="#cb2-336"></a>	<span class="kw">use</span> concord_<span class="ot">`zzz'</span>_1989_2017_abbreviated, clear
</span>
<span id="cb2-337"><a href="#cb2-337"></a>	<span class="kw">replace</span> <span class="fu">year</span>=<span class="fu">year</span>-1900
</span>
<span id="cb2-338"><a href="#cb2-338"></a>	<span class="kw">keep</span> <span class="kw">if</span> <span class="fu">year</span>==100
</span>
<span id="cb2-339"><a href="#cb2-339"></a>	<span class="kw">keep</span> commodity naics
</span>
<span id="cb2-340"><a href="#cb2-340"></a>	<span class="kw">drop</span> <span class="kw">if</span> naics==<span class="st">""</span>
</span>
<span id="cb2-341"><a href="#cb2-341"></a>	<span class="kw">duplicates</span> <span class="kw">drop</span> commodity, <span class="kw">force</span> 
</span>
<span id="cb2-342"><a href="#cb2-342"></a>	<span class="kw">sort</span> commodity
</span>
<span id="cb2-343"><a href="#cb2-343"></a>	<span class="kw">save</span> <span class="ot">`zzz'</span>temp0, replace
</span>
<span id="cb2-344"><a href="#cb2-344"></a>	
</span>
<span id="cb2-345"><a href="#cb2-345"></a>	*Match <span class="ot">list</span> <span class="kw">of</span> 2000 HS-NAICS mappings to pre-2000 years
</span>
<span id="cb2-346"><a href="#cb2-346"></a>	<span class="kw">use</span> concord_<span class="ot">`zzz'</span>_1989_2017_abbreviated, clear
</span>
<span id="cb2-347"><a href="#cb2-347"></a>	<span class="kw">replace</span> <span class="fu">year</span>=<span class="fu">year</span>-1900
</span>
<span id="cb2-348"><a href="#cb2-348"></a>	<span class="kw">keep</span> <span class="kw">if</span> <span class="fu">year</span>&lt;100
</span>
<span id="cb2-349"><a href="#cb2-349"></a>	<span class="kw">keep</span> commodity
</span>
<span id="cb2-350"><a href="#cb2-350"></a>	<span class="kw">duplicates</span> <span class="kw">drop</span> commodity, force
</span>
<span id="cb2-351"><a href="#cb2-351"></a>	<span class="kw">sort</span> commodity
</span>
<span id="cb2-352"><a href="#cb2-352"></a>	<span class="kw">merge</span> commodity <span class="kw">using</span> <span class="ot">`zzz'</span>temp0, <span class="kw">keep</span>(naics) 
</span>
<span id="cb2-353"><a href="#cb2-353"></a>	<span class="kw">tab</span> _merge
</span>
<span id="cb2-354"><a href="#cb2-354"></a>	<span class="kw">drop</span> _merge
</span>
<span id="cb2-355"><a href="#cb2-355"></a>	<span class="kw">gen</span> <span class="kw">double</span> hs=commodity
</span>
<span id="cb2-356"><a href="#cb2-356"></a>	<span class="kw">egen</span> naics87=<span class="fu">group</span>(naics)
</span>
<span id="cb2-357"><a href="#cb2-357"></a>	<span class="kw">save</span> <span class="ot">`zzz'</span>temp_01, replace
</span>
<span id="cb2-358"><a href="#cb2-358"></a>
</span>
<span id="cb2-359"><a href="#cb2-359"></a>	*Save <span class="kw">two</span> versions <span class="kw">of</span> <span class="fu">group</span>-naics mapping <span class="kw">for</span> below.
</span>
<span id="cb2-360"><a href="#cb2-360"></a>	*These are simply used <span class="kw">for</span> labeling the source of
</span>
<span id="cb2-361"><a href="#cb2-361"></a>	*HS-NAICS matches.
</span>
<span id="cb2-362"><a href="#cb2-362"></a>	<span class="kw">use</span> <span class="ot">`zzz'</span>temp_01, clear
</span>
<span id="cb2-363"><a href="#cb2-363"></a>	<span class="kw">collapse</span> (<span class="kw">mean</span>) naics87, <span class="kw">by</span>(naics)
</span>
<span id="cb2-364"><a href="#cb2-364"></a>	<span class="kw">rename</span> naics87 naics87_new1
</span>
<span id="cb2-365"><a href="#cb2-365"></a>	<span class="kw">rename</span> naics naics_new1
</span>
<span id="cb2-366"><a href="#cb2-366"></a>	<span class="kw">drop</span> <span class="kw">if</span> naics_new1==<span class="st">""</span> | naics87_new1==.
</span>
<span id="cb2-367"><a href="#cb2-367"></a>	<span class="kw">sort</span> naics87_new1
</span>
<span id="cb2-368"><a href="#cb2-368"></a>	<span class="kw">save</span> <span class="ot">`zzz'</span>temp1, replace
</span>
<span id="cb2-369"><a href="#cb2-369"></a>	
</span>
<span id="cb2-370"><a href="#cb2-370"></a>	<span class="kw">use</span> <span class="ot">`zzz'</span>temp_01, clear
</span>
<span id="cb2-371"><a href="#cb2-371"></a>	<span class="kw">collapse</span> (<span class="kw">mean</span>) naics87, <span class="kw">by</span>(naics)
</span>
<span id="cb2-372"><a href="#cb2-372"></a>	<span class="kw">rename</span> naics87 naics87_new2
</span>
<span id="cb2-373"><a href="#cb2-373"></a>	<span class="kw">rename</span> naics naics_new2
</span>
<span id="cb2-374"><a href="#cb2-374"></a>	<span class="kw">drop</span> <span class="kw">if</span> naics_new2==<span class="st">""</span> | naics87_new2==.
</span>
<span id="cb2-375"><a href="#cb2-375"></a>	<span class="kw">sort</span> naics87_new2
</span>
<span id="cb2-376"><a href="#cb2-376"></a>	<span class="kw">save</span> <span class="ot">`zzz'</span>temp2, replace
</span>
<span id="cb2-377"><a href="#cb2-377"></a>
</span>
<span id="cb2-378"><a href="#cb2-378"></a>
</span>
<span id="cb2-379"><a href="#cb2-379"></a>	*First Mechanical Match
</span>
<span id="cb2-380"><a href="#cb2-380"></a>	*Look <span class="fu">at</span> NAICS matches <span class="kw">for</span> HS10s within an HS9.  If <span class="ot">all</span> non-missing
</span>
<span id="cb2-381"><a href="#cb2-381"></a>	*NAICS codes are the same, assign that NAICS code to unmatched HS10s within
</span>
<span id="cb2-382"><a href="#cb2-382"></a>	*that HS9.  Repeat <span class="kw">for</span> higher <span class="kw">levels</span> <span class="kw">of</span> aggregation. 
</span>
<span id="cb2-383"><a href="#cb2-383"></a>	<span class="kw">use</span> <span class="ot">`zzz'</span>temp_01, clear
</span>
<span id="cb2-384"><a href="#cb2-384"></a>	<span class="kw">gen</span> naics87_new1 = naics87
</span>
<span id="cb2-385"><a href="#cb2-385"></a>	<span class="kw">sum</span> hs naics87*
</span>
<span id="cb2-386"><a href="#cb2-386"></a>	<span class="kw">quietly</span> {
</span>
<span id="cb2-387"><a href="#cb2-387"></a>	  <span class="kw">foreach</span> x <span class="kw">in</span> 9 8 7 6 5 4 3 2 {
</span>
<span id="cb2-388"><a href="#cb2-388"></a>		<span class="kw">noisily</span> <span class="kw">display</span> [<span class="ot">`x'</span>]
</span>
<span id="cb2-389"><a href="#cb2-389"></a>		<span class="kw">local</span> <span class="fu">y</span>       = 10-<span class="ot">`x'</span>
</span>
<span id="cb2-390"><a href="#cb2-390"></a>		<span class="kw">gen</span> hs<span class="ot">`x'</span>     = <span class="kw">int</span>(hs/(10^<span class="ot">`y'</span>))
</span>
<span id="cb2-391"><a href="#cb2-391"></a>		<span class="kw">egen</span> t1       = <span class="kw">mean</span>(naics87), <span class="kw">by</span>(hs<span class="ot">`x'</span>)
</span>
<span id="cb2-392"><a href="#cb2-392"></a>		<span class="kw">egen</span> t2       = <span class="fu">sd</span>(naics87), <span class="kw">by</span>(hs<span class="ot">`x'</span>)
</span>
<span id="cb2-393"><a href="#cb2-393"></a>		<span class="kw">egen</span> t3       = <span class="fu">count</span>(naics87), <span class="kw">by</span>(hs<span class="ot">`x'</span>)
</span>
<span id="cb2-394"><a href="#cb2-394"></a>		<span class="kw">gen</span> naics87_<span class="ot">`x'</span> = t1 <span class="kw">if</span> t2==0 | t3==1
</span>
<span id="cb2-395"><a href="#cb2-395"></a>		<span class="kw">replace</span> naics87_new1 = naics87_<span class="ot">`x'</span> <span class="kw">if</span> naics87==. &amp; naics87_new1==.
</span>
<span id="cb2-396"><a href="#cb2-396"></a>		<span class="kw">drop</span> t1 t2 t3
</span>
<span id="cb2-397"><a href="#cb2-397"></a>		<span class="kw">drop</span> hs<span class="ot">`x'</span> naics87_<span class="ot">`x'</span>
</span>
<span id="cb2-398"><a href="#cb2-398"></a>	  } 
</span>
<span id="cb2-399"><a href="#cb2-399"></a>	}
</span>
<span id="cb2-400"><a href="#cb2-400"></a>	<span class="kw">sum</span> hs naics87 naics87_new1
</span>
<span id="cb2-401"><a href="#cb2-401"></a>	<span class="kw">sort</span> hs
</span>
<span id="cb2-402"><a href="#cb2-402"></a>	<span class="kw">save</span> <span class="ot">`zzz'</span>temp_02, replace
</span>
<span id="cb2-403"><a href="#cb2-403"></a>	
</span>
<span id="cb2-404"><a href="#cb2-404"></a>	*Second Mechanical Match
</span>
<span id="cb2-405"><a href="#cb2-405"></a>	*Sort HS codes.  For unmatched HS codes (<span class="kw">or</span> contiguous groups <span class="kw">of</span> HS10
</span>
<span id="cb2-406"><a href="#cb2-406"></a>	*codes), look <span class="fu">at</span> the matched HS10 codes that precede and follow.  If
</span>
<span id="cb2-407"><a href="#cb2-407"></a>	*matches <span class="kw">for</span> preceding and following HS10 codes are identical, assign
</span>
<span id="cb2-408"><a href="#cb2-408"></a>	*that NAICS code to the unmatched HS code(<span class="fu">s</span>).
</span>
<span id="cb2-409"><a href="#cb2-409"></a>	<span class="kw">use</span> <span class="ot">`zzz'</span>temp_02, clear
</span>
<span id="cb2-410"><a href="#cb2-410"></a>	<span class="kw">gen</span> naics87_new2 = naics87_new1
</span>
<span id="cb2-411"><a href="#cb2-411"></a>	<span class="kw">gen</span> <span class="kw">begin</span>      = 1 <span class="kw">if</span> naics87_new1==. &amp; naics87_new1[<span class="dt">_n</span>-1]~=.
</span>
<span id="cb2-412"><a href="#cb2-412"></a>	<span class="kw">gen</span> <span class="kw">end</span>        = naics87_new1==. &amp; naics87_new1[<span class="dt">_n</span>+1]~=.
</span>
<span id="cb2-413"><a href="#cb2-413"></a>	<span class="kw">gen</span> bsum       = <span class="kw">sum</span>(<span class="kw">begin</span>)
</span>
<span id="cb2-414"><a href="#cb2-414"></a>	<span class="kw">gen</span> gap        = naics87_new1==.
</span>
<span id="cb2-415"><a href="#cb2-415"></a>	<span class="kw">replace</span> bsum=. <span class="kw">if</span> gap==0
</span>
<span id="cb2-416"><a href="#cb2-416"></a>	<span class="kw">gen</span> sb         = naics87_new1[<span class="dt">_n</span>-1]*begin
</span>
<span id="cb2-417"><a href="#cb2-417"></a>	<span class="kw">gen</span> se         = naics87_new1[<span class="dt">_n</span>+1]*end
</span>
<span id="cb2-418"><a href="#cb2-418"></a>	<span class="kw">egen</span> tb        = <span class="kw">mean</span>(sb), <span class="kw">by</span>(bsum)
</span>
<span id="cb2-419"><a href="#cb2-419"></a>	<span class="kw">egen</span> <span class="kw">te</span>        = <span class="kw">mean</span>(se), <span class="kw">by</span>(bsum)
</span>
<span id="cb2-420"><a href="#cb2-420"></a>	<span class="kw">gen</span> <span class="fu">match</span>      = tb==te
</span>
<span id="cb2-421"><a href="#cb2-421"></a>	<span class="kw">replace</span> naics87_new2 = tb <span class="kw">if</span> <span class="fu">match</span>==1 &amp; naics87_new1==.
</span>
<span id="cb2-422"><a href="#cb2-422"></a>	<span class="kw">sum</span> hs naics87*
</span>
<span id="cb2-423"><a href="#cb2-423"></a>	<span class="kw">drop</span> <span class="kw">begin</span> <span class="kw">end</span> bsum gap sb se tb <span class="kw">te</span> match
</span>
<span id="cb2-424"><a href="#cb2-424"></a>	<span class="kw">sort</span> hs
</span>
<span id="cb2-425"><a href="#cb2-425"></a>	<span class="kw">save</span> <span class="ot">`zzz'</span>temp_03, replace
</span>
<span id="cb2-426"><a href="#cb2-426"></a>	
</span>
<span id="cb2-427"><a href="#cb2-427"></a>	*Merge <span class="kw">in</span> <span class="st">"group"</span> codes created above, which are only used <span class="kw">for</span> labeling.
</span>
<span id="cb2-428"><a href="#cb2-428"></a>	<span class="kw">use</span> <span class="ot">`zzz'</span>temp_03, clear
</span>
<span id="cb2-429"><a href="#cb2-429"></a>	<span class="kw">sort</span> naics87_new1
</span>
<span id="cb2-430"><a href="#cb2-430"></a>	<span class="kw">merge</span> naics87_new1 <span class="kw">using</span> <span class="ot">`zzz'</span>temp1, <span class="kw">keep</span>(naics_new1)
</span>
<span id="cb2-431"><a href="#cb2-431"></a>	<span class="kw">tab</span> _merge
</span>
<span id="cb2-432"><a href="#cb2-432"></a>	<span class="kw">drop</span> _merge
</span>
<span id="cb2-433"><a href="#cb2-433"></a>	<span class="kw">sort</span> naics87_new2
</span>
<span id="cb2-434"><a href="#cb2-434"></a>	<span class="kw">merge</span> naics87_new2 <span class="kw">using</span> <span class="ot">`zzz'</span>temp2, <span class="kw">keep</span>(naics_new2)
</span>
<span id="cb2-435"><a href="#cb2-435"></a>	<span class="kw">tab</span> _merge
</span>
<span id="cb2-436"><a href="#cb2-436"></a>	<span class="kw">drop</span> _merge
</span>
<span id="cb2-437"><a href="#cb2-437"></a>	<span class="kw">sort</span> hs
</span>
<span id="cb2-438"><a href="#cb2-438"></a>	<span class="kw">gen</span> t=naics87_new1~=.
</span>
<span id="cb2-439"><a href="#cb2-439"></a>	<span class="kw">tab</span> t
</span>
<span id="cb2-440"><a href="#cb2-440"></a>	<span class="kw">drop</span> t 
</span>
<span id="cb2-441"><a href="#cb2-441"></a>      <span class="kw">drop</span> naics87*
</span>
<span id="cb2-442"><a href="#cb2-442"></a>	<span class="kw">format</span> hs %15.0g
</span>
<span id="cb2-443"><a href="#cb2-443"></a>	<span class="kw">drop</span> <span class="kw">if</span> hs&lt;100
</span>
<span id="cb2-444"><a href="#cb2-444"></a>	<span class="kw">save</span> <span class="ot">`zzz'</span>_concord_89_117_naicsfillin, replace
</span>
<span id="cb2-445"><a href="#cb2-445"></a>}
</span>
<span id="cb2-446"><a href="#cb2-446"></a>
</span>
<span id="cb2-447"><a href="#cb2-447"></a>
</span>
<span id="cb2-448"><a href="#cb2-448"></a>
</span>
<span id="cb2-449"><a href="#cb2-449"></a>**3 Add <span class="kw">in</span> hand matches to imports and exports, respectively, first <span class="kw">for</span> sic and then <span class="kw">for</span> naics
</span>
<span id="cb2-450"><a href="#cb2-450"></a>*  Any <span class="fu">missing</span> matches after the <span class="fu">last</span> section were matched <span class="kw">by</span> hand <span class="kw">by</span> kitjawat. Add these
</span>
<span id="cb2-451"><a href="#cb2-451"></a>*  hand matches into the <span class="kw">data</span> here and then also create a <span class="kw">variable</span> that identifies each 
</span>
<span id="cb2-452"><a href="#cb2-452"></a>* mapping according to whether it is from Census, mechanical <span class="fu">match</span> 1, mechanical <span class="fu">match</span> 2 or
</span>
<span id="cb2-453"><a href="#cb2-453"></a>*  from kitjawat's hand matching. 
</span>
<span id="cb2-454"><a href="#cb2-454"></a>*
</span>
<span id="cb2-455"><a href="#cb2-455"></a>*  2009.10.16 change sic 2612 to 2621 <span class="kw">in</span> kitjawat_handmatch_imports_sic_20080821 per Justin's email
</span>
<span id="cb2-456"><a href="#cb2-456"></a>*  also add leading <span class="bn">zero</span> to sics from handmatch and fix <span class="fu">missing</span> naics <span class="kw">for</span> 1605106000
</span>
<span id="cb2-457"><a href="#cb2-457"></a>*
</span>
<span id="cb2-458"><a href="#cb2-458"></a>
</span>
<span id="cb2-459"><a href="#cb2-459"></a>
</span>
<span id="cb2-460"><a href="#cb2-460"></a>*imports
</span>
<span id="cb2-461"><a href="#cb2-461"></a>cd <span class="st">"$C"</span>
</span>
<span id="cb2-462"><a href="#cb2-462"></a><span class="kw">use</span> interim/m_concord_89_117_sicfillin, clear
</span>
<span id="cb2-463"><a href="#cb2-463"></a><span class="kw">sort</span> hs
</span>
<span id="cb2-464"><a href="#cb2-464"></a><span class="kw">merge</span> hs <span class="kw">using</span> input/kitjawat_handmatch_imports_sic_20080821
</span>
<span id="cb2-465"><a href="#cb2-465"></a><span class="kw">tab</span> _merge
</span>
<span id="cb2-466"><a href="#cb2-466"></a><span class="kw">drop</span> <span class="kw">if</span> <span class="dt">_merge</span>==2
</span>
<span id="cb2-467"><a href="#cb2-467"></a>*Correction <span class="kw">of</span> typo
</span>
<span id="cb2-468"><a href="#cb2-468"></a><span class="kw">replace</span> kitjawat = 2621 <span class="kw">if</span> kitjawat==2612
</span>
<span id="cb2-469"><a href="#cb2-469"></a><span class="kw">drop</span> _merge
</span>
<span id="cb2-470"><a href="#cb2-470"></a><span class="kw">tostring</span> kitjawat, g(kitjawats)
</span>
<span id="cb2-471"><a href="#cb2-471"></a><span class="kw">replace</span> kitjawats = <span class="st">"0"</span>+kitjawats <span class="kw">if</span> kitjawat&gt;=100 &amp; kitjawat&lt;=999 
</span>
<span id="cb2-472"><a href="#cb2-472"></a><span class="kw">gen</span> id         = <span class="st">"From Census"</span>
</span>
<span id="cb2-473"><a href="#cb2-473"></a><span class="kw">gen</span> newsic     = sic
</span>
<span id="cb2-474"><a href="#cb2-474"></a><span class="kw">replace</span> id     = <span class="st">"From mechanical match 1"</span> <span class="kw">if</span> sic==<span class="st">""</span>
</span>
<span id="cb2-475"><a href="#cb2-475"></a><span class="kw">replace</span> newsic = sic_new1 <span class="kw">if</span> sic==<span class="st">""</span>
</span>
<span id="cb2-476"><a href="#cb2-476"></a><span class="kw">replace</span> id     = <span class="st">"From mechanical match 2"</span> <span class="kw">if</span> newsic==<span class="st">""</span>
</span>
<span id="cb2-477"><a href="#cb2-477"></a><span class="kw">replace</span> newsic = sic_new2 <span class="kw">if</span> newsic==<span class="st">""</span>
</span>
<span id="cb2-478"><a href="#cb2-478"></a><span class="kw">replace</span> id     = <span class="st">"From hand match"</span> <span class="kw">if</span> newsic==<span class="st">""</span>
</span>
<span id="cb2-479"><a href="#cb2-479"></a><span class="kw">replace</span> newsic = kitjawats <span class="kw">if</span> newsic==<span class="st">""</span>
</span>
<span id="cb2-480"><a href="#cb2-480"></a><span class="kw">label</span> <span class="kw">var</span> id <span class="st">"SIC match type"</span>
</span>
<span id="cb2-481"><a href="#cb2-481"></a><span class="kw">keep</span> commodity hs newsic id
</span>
<span id="cb2-482"><a href="#cb2-482"></a><span class="kw">rename</span> newsic sic 
</span>
<span id="cb2-483"><a href="#cb2-483"></a><span class="kw">rename</span> id sic_matchtype
</span>
<span id="cb2-484"><a href="#cb2-484"></a><span class="kw">rename</span> sic new_sic
</span>
<span id="cb2-485"><a href="#cb2-485"></a><span class="kw">keep</span> commodity new_sic sic_matchtype
</span>
<span id="cb2-486"><a href="#cb2-486"></a><span class="kw">order</span> commodity new_sic sic_matchtype
</span>
<span id="cb2-487"><a href="#cb2-487"></a><span class="kw">sort</span> commodity
</span>
<span id="cb2-488"><a href="#cb2-488"></a><span class="kw">save</span> interim/sic_m_final, replace
</span>
<span id="cb2-489"><a href="#cb2-489"></a>
</span>
<span id="cb2-490"><a href="#cb2-490"></a>cd <span class="st">"$C"</span>
</span>
<span id="cb2-491"><a href="#cb2-491"></a><span class="kw">use</span> interim/m_concord_89_117_naicsfillin, clear
</span>
<span id="cb2-492"><a href="#cb2-492"></a><span class="kw">sort</span> hs
</span>
<span id="cb2-493"><a href="#cb2-493"></a><span class="kw">merge</span> hs <span class="kw">using</span> input/kitjawat_handmatch_imports_naics_20081016
</span>
<span id="cb2-494"><a href="#cb2-494"></a><span class="kw">tab</span> _merge
</span>
<span id="cb2-495"><a href="#cb2-495"></a><span class="kw">drop</span> <span class="kw">if</span> <span class="dt">_merge</span>==2
</span>
<span id="cb2-496"><a href="#cb2-496"></a><span class="kw">drop</span> _merge
</span>
<span id="cb2-497"><a href="#cb2-497"></a><span class="kw">tostring</span> kitjawat, g(kitjawats)
</span>
<span id="cb2-498"><a href="#cb2-498"></a>*Correct typo
</span>
<span id="cb2-499"><a href="#cb2-499"></a><span class="kw">replace</span> kitjawats = <span class="st">"311711"</span> <span class="kw">if</span> commodity==1605106000
</span>
<span id="cb2-500"><a href="#cb2-500"></a><span class="kw">gen</span> id           = <span class="st">"From Census"</span>
</span>
<span id="cb2-501"><a href="#cb2-501"></a><span class="kw">gen</span> newnaics     = naics
</span>
<span id="cb2-502"><a href="#cb2-502"></a><span class="kw">replace</span> id       = <span class="st">"From mechanical match 1"</span> <span class="kw">if</span> naics==<span class="st">""</span>
</span>
<span id="cb2-503"><a href="#cb2-503"></a><span class="kw">replace</span> newnaics = naics_new1 <span class="kw">if</span> naics==<span class="st">""</span>
</span>
<span id="cb2-504"><a href="#cb2-504"></a><span class="kw">replace</span> id       = <span class="st">"From mechanical match 2"</span> <span class="kw">if</span> newnaics==<span class="st">""</span>
</span>
<span id="cb2-505"><a href="#cb2-505"></a><span class="kw">replace</span> newnaics = naics_new2 <span class="kw">if</span> newnaics==<span class="st">""</span>
</span>
<span id="cb2-506"><a href="#cb2-506"></a><span class="kw">replace</span> id       = <span class="st">"From hand match"</span> <span class="kw">if</span> newnaics==<span class="st">""</span>
</span>
<span id="cb2-507"><a href="#cb2-507"></a><span class="kw">replace</span> newnaics = kitjawats <span class="kw">if</span> newnaics==<span class="st">""</span>
</span>
<span id="cb2-508"><a href="#cb2-508"></a><span class="kw">label</span> <span class="kw">var</span> id <span class="st">"NAICS match type"</span>
</span>
<span id="cb2-509"><a href="#cb2-509"></a><span class="kw">drop</span> naics
</span>
<span id="cb2-510"><a href="#cb2-510"></a><span class="kw">rename</span> newnaics naics 
</span>
<span id="cb2-511"><a href="#cb2-511"></a><span class="kw">rename</span> id naics_matchtype
</span>
<span id="cb2-512"><a href="#cb2-512"></a><span class="kw">rename</span> naics new_naics
</span>
<span id="cb2-513"><a href="#cb2-513"></a><span class="kw">keep</span> commodity new_naics naics_matchtype
</span>
<span id="cb2-514"><a href="#cb2-514"></a><span class="kw">order</span> commodity new_naics naics_matchtype
</span>
<span id="cb2-515"><a href="#cb2-515"></a><span class="kw">sort</span> commodity
</span>
<span id="cb2-516"><a href="#cb2-516"></a><span class="kw">save</span> interim/naics_m_final, replace
</span>
<span id="cb2-517"><a href="#cb2-517"></a>
</span>
<span id="cb2-518"><a href="#cb2-518"></a>
</span>
<span id="cb2-519"><a href="#cb2-519"></a>*exports
</span>
<span id="cb2-520"><a href="#cb2-520"></a>cd <span class="st">"$C"</span>
</span>
<span id="cb2-521"><a href="#cb2-521"></a><span class="kw">use</span> interim/x_concord_89_117_sicfillin, clear
</span>
<span id="cb2-522"><a href="#cb2-522"></a><span class="kw">sort</span> hs
</span>
<span id="cb2-523"><a href="#cb2-523"></a><span class="kw">merge</span> hs <span class="kw">using</span> input/kitjawat_handmatch_exports_sic_20080821
</span>
<span id="cb2-524"><a href="#cb2-524"></a><span class="kw">tab</span> _merge
</span>
<span id="cb2-525"><a href="#cb2-525"></a><span class="kw">drop</span> <span class="kw">if</span> <span class="dt">_merge</span>==2
</span>
<span id="cb2-526"><a href="#cb2-526"></a><span class="kw">drop</span> _merge
</span>
<span id="cb2-527"><a href="#cb2-527"></a><span class="kw">tostring</span> kitjawat, g(kitjawats)
</span>
<span id="cb2-528"><a href="#cb2-528"></a><span class="kw">replace</span> kitjawats = <span class="st">"0"</span>+kitjawats <span class="kw">if</span> kitjawat&gt;=100 &amp; kitjawat&lt;=999 
</span>
<span id="cb2-529"><a href="#cb2-529"></a><span class="kw">gen</span> id         = <span class="st">"From Census"</span>
</span>
<span id="cb2-530"><a href="#cb2-530"></a><span class="kw">gen</span> newsic     = sic
</span>
<span id="cb2-531"><a href="#cb2-531"></a><span class="kw">replace</span> id     = <span class="st">"From mechanical match 1"</span> <span class="kw">if</span> sic==<span class="st">""</span>
</span>
<span id="cb2-532"><a href="#cb2-532"></a><span class="kw">replace</span> newsic = sic_new1 <span class="kw">if</span> sic==<span class="st">""</span>
</span>
<span id="cb2-533"><a href="#cb2-533"></a><span class="kw">replace</span> id     = <span class="st">"From mechanical match 2"</span> <span class="kw">if</span> newsic==<span class="st">""</span>
</span>
<span id="cb2-534"><a href="#cb2-534"></a><span class="kw">replace</span> newsic = sic_new2 <span class="kw">if</span> newsic==<span class="st">""</span>
</span>
<span id="cb2-535"><a href="#cb2-535"></a><span class="kw">replace</span> id     = <span class="st">"From hand match"</span> <span class="kw">if</span> newsic==<span class="st">""</span>
</span>
<span id="cb2-536"><a href="#cb2-536"></a><span class="kw">replace</span> newsic = kitjawats <span class="kw">if</span> newsic==<span class="st">""</span>
</span>
<span id="cb2-537"><a href="#cb2-537"></a><span class="kw">label</span> <span class="kw">var</span> id <span class="st">"SIC match type"</span>
</span>
<span id="cb2-538"><a href="#cb2-538"></a><span class="kw">drop</span> sic
</span>
<span id="cb2-539"><a href="#cb2-539"></a><span class="kw">rename</span> newsic sic 
</span>
<span id="cb2-540"><a href="#cb2-540"></a><span class="kw">rename</span> id sic_matchtype
</span>
<span id="cb2-541"><a href="#cb2-541"></a><span class="kw">rename</span> sic new_sic
</span>
<span id="cb2-542"><a href="#cb2-542"></a><span class="kw">keep</span> commodity new_sic sic_matchtype
</span>
<span id="cb2-543"><a href="#cb2-543"></a><span class="kw">order</span> commodity new_sic sic_matchtype
</span>
<span id="cb2-544"><a href="#cb2-544"></a><span class="kw">sort</span> commodity
</span>
<span id="cb2-545"><a href="#cb2-545"></a><span class="kw">save</span> interim/sic_x_final, replace
</span>
<span id="cb2-546"><a href="#cb2-546"></a>
</span>
<span id="cb2-547"><a href="#cb2-547"></a>cd <span class="st">"$C"</span>
</span>
<span id="cb2-548"><a href="#cb2-548"></a><span class="kw">use</span> interim/x_concord_89_117_naicsfillin, clear
</span>
<span id="cb2-549"><a href="#cb2-549"></a><span class="kw">sort</span> hs
</span>
<span id="cb2-550"><a href="#cb2-550"></a><span class="kw">merge</span> hs <span class="kw">using</span> input/kitjawat_handmatch_exports_naics_20081016
</span>
<span id="cb2-551"><a href="#cb2-551"></a><span class="kw">tab</span> _merge
</span>
<span id="cb2-552"><a href="#cb2-552"></a><span class="kw">drop</span> <span class="kw">if</span> <span class="dt">_merge</span>==2
</span>
<span id="cb2-553"><a href="#cb2-553"></a><span class="kw">drop</span> _merge
</span>
<span id="cb2-554"><a href="#cb2-554"></a><span class="kw">tostring</span> kitjawat, g(kitjawats)
</span>
<span id="cb2-555"><a href="#cb2-555"></a><span class="kw">gen</span> id           = <span class="st">"From Census"</span>
</span>
<span id="cb2-556"><a href="#cb2-556"></a><span class="kw">gen</span> newnaics     = naics
</span>
<span id="cb2-557"><a href="#cb2-557"></a><span class="kw">replace</span> id       = <span class="st">"From mechanical match 1"</span> <span class="kw">if</span> naics==<span class="st">""</span>
</span>
<span id="cb2-558"><a href="#cb2-558"></a><span class="kw">replace</span> newnaics = naics_new1 <span class="kw">if</span> naics==<span class="st">""</span>
</span>
<span id="cb2-559"><a href="#cb2-559"></a><span class="kw">replace</span> id       = <span class="st">"From mechanical match 2"</span> <span class="kw">if</span> newnaics==<span class="st">""</span>
</span>
<span id="cb2-560"><a href="#cb2-560"></a><span class="kw">replace</span> newnaics = naics_new2 <span class="kw">if</span> newnaics==<span class="st">""</span>
</span>
<span id="cb2-561"><a href="#cb2-561"></a><span class="kw">replace</span> id       = <span class="st">"From hand match"</span> <span class="kw">if</span> newnaics==<span class="st">""</span>
</span>
<span id="cb2-562"><a href="#cb2-562"></a><span class="kw">replace</span> newnaics = kitjawats <span class="kw">if</span> newnaics==<span class="st">""</span>
</span>
<span id="cb2-563"><a href="#cb2-563"></a><span class="kw">label</span> <span class="kw">var</span> id <span class="st">"NAICS match type"</span>
</span>
<span id="cb2-564"><a href="#cb2-564"></a><span class="kw">drop</span> naics
</span>
<span id="cb2-565"><a href="#cb2-565"></a><span class="kw">rename</span> newnaics naics 
</span>
<span id="cb2-566"><a href="#cb2-566"></a><span class="kw">rename</span> id naics_matchtype
</span>
<span id="cb2-567"><a href="#cb2-567"></a><span class="kw">rename</span> naics new_naics
</span>
<span id="cb2-568"><a href="#cb2-568"></a><span class="kw">keep</span> commodity new_naics naics_matchtype
</span>
<span id="cb2-569"><a href="#cb2-569"></a><span class="kw">order</span> commodity new_naics naics_matchtype
</span>
<span id="cb2-570"><a href="#cb2-570"></a><span class="kw">sort</span> commodity
</span>
<span id="cb2-571"><a href="#cb2-571"></a><span class="kw">save</span> interim/naics_x_final, replace
</span>
<span id="cb2-572"><a href="#cb2-572"></a>
</span>
<span id="cb2-573"><a href="#cb2-573"></a>
</span>
<span id="cb2-574"><a href="#cb2-574"></a>
</span>
<span id="cb2-575"><a href="#cb2-575"></a>**4 Check how many naics are <span class="kw">in</span> concordance but <span class="kw">not</span> official <span class="ot">list</span>, and vice versa.
</span>
<span id="cb2-576"><a href="#cb2-576"></a>*Then, create a <span class="kw">new</span> NAICS code, NAICSX, that <span class="kw">for</span> a given parent will <span class="kw">replace</span> all
</span>
<span id="cb2-577"><a href="#cb2-577"></a>*children's codes with the parent root and X(<span class="fu">s</span>) <span class="kw">if</span> one <span class="kw">or</span> <span class="kw">more</span> children are <span class="fu">missing</span> from 
</span>
<span id="cb2-578"><a href="#cb2-578"></a>*the census concordances.
</span>
<span id="cb2-579"><a href="#cb2-579"></a>*
</span>
<span id="cb2-580"><a href="#cb2-580"></a>*
</span>
<span id="cb2-581"><a href="#cb2-581"></a>
</span>
<span id="cb2-582"><a href="#cb2-582"></a>*4.0 Assemble full <span class="ot">list</span> <span class="kw">of</span> naics codes <span class="kw">by</span> vintage
</span>
<span id="cb2-583"><a href="#cb2-583"></a>*
</span>
<span id="cb2-584"><a href="#cb2-584"></a>*	Assume here that:
</span>
<span id="cb2-585"><a href="#cb2-585"></a>*	
</span>
<span id="cb2-586"><a href="#cb2-586"></a>*		1997 codes used from 1989-2001
</span>
<span id="cb2-587"><a href="#cb2-587"></a>*		2002 codes used from 2002-2006
</span>
<span id="cb2-588"><a href="#cb2-588"></a>*		2007 codes used from 2007-2012
</span>
<span id="cb2-589"><a href="#cb2-589"></a>*		2012 codes used from 2013-2017
</span>
<span id="cb2-590"><a href="#cb2-590"></a>*		2017 codes used <span class="kw">for</span> 2017
</span>
<span id="cb2-591"><a href="#cb2-591"></a>*
</span>
<span id="cb2-592"><a href="#cb2-592"></a>* 		List <span class="kw">of</span> NAICS codes avaialable <span class="fu">at</span>:
</span>
<span id="cb2-593"><a href="#cb2-593"></a>*		https:<span class="co">//www.census.gov/eos/www/naics/concordances/concordances.html
</span></span>
<span id="cb2-594"><a href="#cb2-594"></a>*
</span>
<span id="cb2-595"><a href="#cb2-595"></a>*
</span>
<span id="cb2-596"><a href="#cb2-596"></a>
</span>
<span id="cb2-597"><a href="#cb2-597"></a>*6-digit
</span>
<span id="cb2-598"><a href="#cb2-598"></a>cd <span class="st">"$NC"</span>
</span>
<span id="cb2-599"><a href="#cb2-599"></a><span class="kw">foreach</span> <span class="fu">y</span> <span class="kw">in</span> 1989  {
</span>
<span id="cb2-600"><a href="#cb2-600"></a>	<span class="kw">use</span> naics_1997, clear
</span>
<span id="cb2-601"><a href="#cb2-601"></a>	<span class="kw">duplicates</span> drop
</span>
<span id="cb2-602"><a href="#cb2-602"></a>	<span class="kw">gen</span> <span class="fu">year</span>=1989
</span>
<span id="cb2-603"><a href="#cb2-603"></a>	<span class="kw">forvalues</span> c=1/7 {
</span>
<span id="cb2-604"><a href="#cb2-604"></a>		<span class="kw">append</span> <span class="kw">using</span> naics_1997
</span>
<span id="cb2-605"><a href="#cb2-605"></a>		<span class="kw">replace</span> <span class="fu">year</span>=<span class="ot">`y'</span>+<span class="ot">`c'</span> <span class="kw">if</span> <span class="fu">year</span>==.
</span>
<span id="cb2-606"><a href="#cb2-606"></a>	}
</span>
<span id="cb2-607"><a href="#cb2-607"></a>	<span class="kw">drop</span> <span class="kw">if</span> naics97==.
</span>
<span id="cb2-608"><a href="#cb2-608"></a>	<span class="kw">save</span> naics_1989_year, replace
</span>
<span id="cb2-609"><a href="#cb2-609"></a>}
</span>
<span id="cb2-610"><a href="#cb2-610"></a><span class="kw">tab</span> year
</span>
<span id="cb2-611"><a href="#cb2-611"></a><span class="kw">foreach</span> <span class="fu">y</span> <span class="kw">in</span> 1997 2002  {
</span>
<span id="cb2-612"><a href="#cb2-612"></a>	<span class="kw">use</span> naics_<span class="ot">`y'</span>, clear
</span>
<span id="cb2-613"><a href="#cb2-613"></a>	<span class="kw">duplicates</span> drop
</span>
<span id="cb2-614"><a href="#cb2-614"></a>	<span class="kw">gen</span> <span class="fu">year</span>=<span class="ot">`y'</span>
</span>
<span id="cb2-615"><a href="#cb2-615"></a>	<span class="kw">forvalues</span> c=1/4 {
</span>
<span id="cb2-616"><a href="#cb2-616"></a>		<span class="kw">append</span> <span class="kw">using</span> naics_<span class="ot">`y'</span>
</span>
<span id="cb2-617"><a href="#cb2-617"></a>		<span class="kw">replace</span> <span class="fu">year</span>=<span class="ot">`y'</span>+<span class="ot">`c'</span> <span class="kw">if</span> <span class="fu">year</span>==.
</span>
<span id="cb2-618"><a href="#cb2-618"></a>	}
</span>
<span id="cb2-619"><a href="#cb2-619"></a>	<span class="kw">capture</span> <span class="kw">drop</span> <span class="kw">if</span> naics97==.
</span>
<span id="cb2-620"><a href="#cb2-620"></a>	<span class="kw">capture</span> <span class="kw">drop</span> <span class="kw">if</span> naics02==.
</span>
<span id="cb2-621"><a href="#cb2-621"></a>	<span class="kw">save</span> naics_<span class="ot">`y'</span>_year, replace
</span>
<span id="cb2-622"><a href="#cb2-622"></a>}
</span>
<span id="cb2-623"><a href="#cb2-623"></a><span class="kw">tab</span> year
</span>
<span id="cb2-624"><a href="#cb2-624"></a>cd <span class="st">"$NC"</span>
</span>
<span id="cb2-625"><a href="#cb2-625"></a><span class="kw">foreach</span> <span class="fu">y</span> <span class="kw">in</span> 2007  {
</span>
<span id="cb2-626"><a href="#cb2-626"></a>	<span class="kw">use</span> naics_2007, <span class="kw">clear</span>			<span class="co">/*end 2007 a year later*/</span>
</span>
<span id="cb2-627"><a href="#cb2-627"></a>	<span class="kw">duplicates</span> drop
</span>
<span id="cb2-628"><a href="#cb2-628"></a>	<span class="kw">gen</span> <span class="fu">year</span>=2007
</span>
<span id="cb2-629"><a href="#cb2-629"></a>	<span class="kw">forvalues</span> c=1/5 {
</span>
<span id="cb2-630"><a href="#cb2-630"></a>		<span class="kw">append</span> <span class="kw">using</span> naics_2007
</span>
<span id="cb2-631"><a href="#cb2-631"></a>		<span class="kw">replace</span> <span class="fu">year</span>=<span class="ot">`y'</span>+<span class="ot">`c'</span> <span class="kw">if</span> <span class="fu">year</span>==.
</span>
<span id="cb2-632"><a href="#cb2-632"></a>	}
</span>
<span id="cb2-633"><a href="#cb2-633"></a>	<span class="kw">drop</span> <span class="kw">if</span> naics07==.
</span>
<span id="cb2-634"><a href="#cb2-634"></a>	<span class="kw">save</span> naics_2007_year, replace
</span>
<span id="cb2-635"><a href="#cb2-635"></a>}
</span>
<span id="cb2-636"><a href="#cb2-636"></a><span class="kw">tab</span> year
</span>
<span id="cb2-637"><a href="#cb2-637"></a><span class="kw">foreach</span> <span class="fu">y</span> <span class="kw">in</span> 2012  {
</span>
<span id="cb2-638"><a href="#cb2-638"></a>	<span class="kw">use</span> naics_2012, <span class="kw">clear</span>			<span class="co">/*start 2012 a year late*/</span>
</span>
<span id="cb2-639"><a href="#cb2-639"></a>	<span class="kw">duplicates</span> drop
</span>
<span id="cb2-640"><a href="#cb2-640"></a>	<span class="kw">gen</span> <span class="fu">year</span>=2013
</span>
<span id="cb2-641"><a href="#cb2-641"></a>	<span class="kw">forvalues</span> c=1/4 {
</span>
<span id="cb2-642"><a href="#cb2-642"></a>		<span class="kw">append</span> <span class="kw">using</span> naics_2012
</span>
<span id="cb2-643"><a href="#cb2-643"></a>		<span class="kw">replace</span> <span class="fu">year</span>=<span class="ot">`y'</span>+<span class="ot">`c'</span> <span class="kw">if</span> <span class="fu">year</span>==.
</span>
<span id="cb2-644"><a href="#cb2-644"></a>	}
</span>
<span id="cb2-645"><a href="#cb2-645"></a>	<span class="kw">drop</span> <span class="kw">if</span> naics12==.
</span>
<span id="cb2-646"><a href="#cb2-646"></a>	<span class="kw">save</span> naics_2012_year, replace
</span>
<span id="cb2-647"><a href="#cb2-647"></a>}
</span>
<span id="cb2-648"><a href="#cb2-648"></a><span class="kw">tab</span> year
</span>
<span id="cb2-649"><a href="#cb2-649"></a><span class="kw">foreach</span> <span class="fu">y</span> <span class="kw">in</span> 2017  {
</span>
<span id="cb2-650"><a href="#cb2-650"></a>	<span class="kw">use</span> naics_2017, <span class="kw">clear</span>			<span class="co">/*start 2012 a year late*/</span>
</span>
<span id="cb2-651"><a href="#cb2-651"></a>	<span class="kw">duplicates</span> drop
</span>
<span id="cb2-652"><a href="#cb2-652"></a>	<span class="kw">gen</span> <span class="fu">year</span>=2017
</span>
<span id="cb2-653"><a href="#cb2-653"></a>	<span class="kw">drop</span> <span class="kw">if</span> naics17==.
</span>
<span id="cb2-654"><a href="#cb2-654"></a>	<span class="kw">save</span> naics_2017_year, replace
</span>
<span id="cb2-655"><a href="#cb2-655"></a>}
</span>
<span id="cb2-656"><a href="#cb2-656"></a><span class="kw">tab</span> year
</span>
<span id="cb2-657"><a href="#cb2-657"></a>
</span>
<span id="cb2-658"><a href="#cb2-658"></a><span class="kw">use</span> naics_1989_year, clear
</span>
<span id="cb2-659"><a href="#cb2-659"></a><span class="kw">append</span> <span class="kw">using</span> naics_1997_year
</span>
<span id="cb2-660"><a href="#cb2-660"></a><span class="kw">rename</span> naics97 naics02
</span>
<span id="cb2-661"><a href="#cb2-661"></a><span class="kw">append</span> <span class="kw">using</span> naics_2002_year
</span>
<span id="cb2-662"><a href="#cb2-662"></a><span class="kw">rename</span> naics02 naics07
</span>
<span id="cb2-663"><a href="#cb2-663"></a><span class="kw">append</span> <span class="kw">using</span> naics_2007_year
</span>
<span id="cb2-664"><a href="#cb2-664"></a><span class="kw">rename</span> naics07 naics12
</span>
<span id="cb2-665"><a href="#cb2-665"></a><span class="kw">append</span> <span class="kw">using</span> naics_2012_year
</span>
<span id="cb2-666"><a href="#cb2-666"></a><span class="kw">rename</span> naics12 naics17
</span>
<span id="cb2-667"><a href="#cb2-667"></a><span class="kw">append</span> <span class="kw">using</span> naics_2017_year
</span>
<span id="cb2-668"><a href="#cb2-668"></a><span class="kw">rename</span> naics17 naics
</span>
<span id="cb2-669"><a href="#cb2-669"></a>
</span>
<span id="cb2-670"><a href="#cb2-670"></a><span class="kw">drop</span> <span class="bn">title</span>*
</span>
<span id="cb2-671"><a href="#cb2-671"></a><span class="kw">drop</span> *title
</span>
<span id="cb2-672"><a href="#cb2-672"></a><span class="kw">gen</span> i = 1
</span>
<span id="cb2-673"><a href="#cb2-673"></a><span class="kw">rename</span> naics nnaics
</span>
<span id="cb2-674"><a href="#cb2-674"></a><span class="kw">tostring</span> nnaics, <span class="kw">force</span> g(naics)
</span>
<span id="cb2-675"><a href="#cb2-675"></a><span class="kw">duplicates</span> drop
</span>
<span id="cb2-676"><a href="#cb2-676"></a><span class="kw">save</span> naics_year, replace
</span>
<span id="cb2-677"><a href="#cb2-677"></a><span class="kw">tab</span> year
</span>
<span id="cb2-678"><a href="#cb2-678"></a>
</span>
<span id="cb2-679"><a href="#cb2-679"></a>*how many man codes <span class="kw">in</span> above
</span>
<span id="cb2-680"><a href="#cb2-680"></a><span class="kw">use</span> naics_year, clear
</span>
<span id="cb2-681"><a href="#cb2-681"></a><span class="kw">gen</span> man =<span class="fu">substr</span>(naics,1,1)==<span class="st">"3"</span>
</span>
<span id="cb2-682"><a href="#cb2-682"></a><span class="kw">egen</span> x = <span class="fu">tag</span>(naics <span class="fu">year</span>)
</span>
<span id="cb2-683"><a href="#cb2-683"></a><span class="kw">table</span> <span class="fu">year</span> <span class="kw">if</span> x, c(<span class="kw">sum</span> man)
</span>
<span id="cb2-684"><a href="#cb2-684"></a>
</span>
<span id="cb2-685"><a href="#cb2-685"></a>*5-digit
</span>
<span id="cb2-686"><a href="#cb2-686"></a>cd <span class="st">"$NC"</span>
</span>
<span id="cb2-687"><a href="#cb2-687"></a><span class="kw">use</span> naics_year, clear
</span>
<span id="cb2-688"><a href="#cb2-688"></a><span class="kw">keep</span> naics year
</span>
<span id="cb2-689"><a href="#cb2-689"></a><span class="kw">gen</span> naics5 = <span class="fu">substr</span>(naics,1,5)
</span>
<span id="cb2-690"><a href="#cb2-690"></a><span class="kw">keep</span> naics5 year
</span>
<span id="cb2-691"><a href="#cb2-691"></a><span class="kw">duplicates</span> drop
</span>
<span id="cb2-692"><a href="#cb2-692"></a><span class="kw">save</span> naics5_year, replace
</span>
<span id="cb2-693"><a href="#cb2-693"></a>
</span>
<span id="cb2-694"><a href="#cb2-694"></a>*4-digit
</span>
<span id="cb2-695"><a href="#cb2-695"></a>cd <span class="st">"$NC"</span>
</span>
<span id="cb2-696"><a href="#cb2-696"></a><span class="kw">use</span> naics_year, clear
</span>
<span id="cb2-697"><a href="#cb2-697"></a><span class="kw">gen</span> naics4 = <span class="fu">substr</span>(naics,1,4)
</span>
<span id="cb2-698"><a href="#cb2-698"></a><span class="kw">keep</span> naics4 year
</span>
<span id="cb2-699"><a href="#cb2-699"></a><span class="kw">duplicates</span> drop
</span>
<span id="cb2-700"><a href="#cb2-700"></a><span class="kw">save</span> naics4_year, replace
</span>
<span id="cb2-701"><a href="#cb2-701"></a>
</span>
<span id="cb2-702"><a href="#cb2-702"></a>
</span>
<span id="cb2-703"><a href="#cb2-703"></a>
</span>
<span id="cb2-704"><a href="#cb2-704"></a>
</span>
<span id="cb2-705"><a href="#cb2-705"></a>
</span>
<span id="cb2-706"><a href="#cb2-706"></a>*4.1 Merge official NAICS lists assembled above into HS-NAICS concordance
</span>
<span id="cb2-707"><a href="#cb2-707"></a><span class="kw">foreach</span> t <span class="kw">in</span> <span class="fu">m</span> x {
</span>
<span id="cb2-708"><a href="#cb2-708"></a>	cd <span class="st">"$C"</span>
</span>
<span id="cb2-709"><a href="#cb2-709"></a>	<span class="kw">use</span> interim/concord_<span class="ot">`t'</span>_1989_2017_abbreviated, clear
</span>
<span id="cb2-710"><a href="#cb2-710"></a>	<span class="kw">sort</span> commodity
</span>
<span id="cb2-711"><a href="#cb2-711"></a>	<span class="kw">merge</span> commodity <span class="kw">using</span> interim/sic_<span class="ot">`t'</span>_final
</span>
<span id="cb2-712"><a href="#cb2-712"></a>	<span class="kw">tab</span> _merge
</span>
<span id="cb2-713"><a href="#cb2-713"></a>	<span class="kw">drop</span> _merge
</span>
<span id="cb2-714"><a href="#cb2-714"></a>	<span class="kw">replace</span> sic_matchtype=<span class="st">"From Census"</span> <span class="kw">if</span> sic!=<span class="st">""</span>
</span>
<span id="cb2-715"><a href="#cb2-715"></a>	<span class="kw">replace</span> sic=new_sic <span class="kw">if</span> sic==<span class="st">""</span> &amp; new_sic!=<span class="st">""</span>
</span>
<span id="cb2-716"><a href="#cb2-716"></a>	<span class="kw">sort</span> commodity
</span>
<span id="cb2-717"><a href="#cb2-717"></a>	<span class="kw">merge</span> commodity <span class="kw">using</span> interim/naics_<span class="ot">`t'</span>_final
</span>
<span id="cb2-718"><a href="#cb2-718"></a>	<span class="kw">tab</span> _merge
</span>
<span id="cb2-719"><a href="#cb2-719"></a>	<span class="kw">drop</span> _merge
</span>
<span id="cb2-720"><a href="#cb2-720"></a>	<span class="kw">replace</span> naics_matchtype=<span class="st">"From Census"</span> <span class="kw">if</span> naics!=<span class="st">""</span>
</span>
<span id="cb2-721"><a href="#cb2-721"></a>	<span class="kw">replace</span> naics=new_naics <span class="kw">if</span> naics==<span class="st">""</span> &amp; new_naics!=<span class="st">""</span>
</span>
<span id="cb2-722"><a href="#cb2-722"></a>	<span class="kw">drop</span> <span class="kw">new</span>* 
</span>
<span id="cb2-723"><a href="#cb2-723"></a>	<span class="kw">destring</span> commodity, g(hs) force
</span>
<span id="cb2-724"><a href="#cb2-724"></a>	<span class="kw">drop</span> <span class="kw">if</span> commodity==.
</span>
<span id="cb2-725"><a href="#cb2-725"></a>	<span class="kw">order</span> commodity <span class="fu">year</span> sic sic_matchtype naics naics_matchtype
</span>
<span id="cb2-726"><a href="#cb2-726"></a>	<span class="kw">sort</span> commodity year
</span>
<span id="cb2-727"><a href="#cb2-727"></a>	<span class="kw">format</span> commodity %15.0fc
</span>
<span id="cb2-728"><a href="#cb2-728"></a>	<span class="kw">gen</span> <span class="kw">double</span> hs=commodity
</span>
<span id="cb2-729"><a href="#cb2-729"></a>	*Label which codes are only <span class="kw">in</span> trade concordances, only <span class="kw">in</span> official
</span>
<span id="cb2-730"><a href="#cb2-730"></a>	*NAICS <span class="ot">list</span>, <span class="kw">or</span> both
</span>
<span id="cb2-731"><a href="#cb2-731"></a>	<span class="kw">merge</span> <span class="fu">m</span>:1 naics <span class="fu">year</span> <span class="kw">using</span> input/naics/naics_year
</span>
<span id="cb2-732"><a href="#cb2-732"></a>	<span class="kw">egen</span> x = <span class="fu">tag</span>(naics <span class="fu">year</span>)
</span>
<span id="cb2-733"><a href="#cb2-733"></a>	<span class="kw">gen</span> man = <span class="fu">substr</span>(naics,1,1)==<span class="st">"3"</span>
</span>
<span id="cb2-734"><a href="#cb2-734"></a>	<span class="kw">tab</span> _merge
</span>
<span id="cb2-735"><a href="#cb2-735"></a>	<span class="kw">table</span> <span class="fu">year</span> <span class="dt">_merge</span> <span class="kw">if</span> x, c(<span class="kw">sum</span> man)
</span>
<span id="cb2-736"><a href="#cb2-736"></a>	<span class="kw">gen</span> naics_origin = <span class="st">""</span>
</span>
<span id="cb2-737"><a href="#cb2-737"></a>	<span class="kw">replace</span> naics_origin = <span class="st">"in concordance only"</span> <span class="kw">if</span> <span class="dt">_merge</span>==1
</span>
<span id="cb2-738"><a href="#cb2-738"></a>	<span class="kw">replace</span> naics_origin = <span class="st">"in official naics list only"</span> <span class="kw">if</span> <span class="dt">_merge</span>==2
</span>
<span id="cb2-739"><a href="#cb2-739"></a>	<span class="kw">replace</span> naics_origin = <span class="st">"in both concordance and official naics list"</span> <span class="kw">if</span> <span class="dt">_merge</span>==3
</span>
<span id="cb2-740"><a href="#cb2-740"></a>	
</span>
<span id="cb2-741"><a href="#cb2-741"></a>	*Create <span class="kw">variable</span> naicsX that replaces <span class="fu">last</span> character <span class="kw">of</span> NAICS with 
</span>
<span id="cb2-742"><a href="#cb2-742"></a>	*X <span class="kw">if</span> 5-digit parent is <span class="fu">missing</span> a child, where <span class="fu">missing</span> refers to
</span>
<span id="cb2-743"><a href="#cb2-743"></a>	*a NAICS codes that is <span class="kw">in</span> the official <span class="ot">list</span> but doesn't appear <span class="kw">in</span> the 
</span>
<span id="cb2-744"><a href="#cb2-744"></a>	*trade concordances from Census.
</span>
<span id="cb2-745"><a href="#cb2-745"></a>	<span class="kw">gen</span> naicsX = naics
</span>
<span id="cb2-746"><a href="#cb2-746"></a>	<span class="kw">gen</span> n5 = <span class="fu">substr</span>(naics,1,5)
</span>
<span id="cb2-747"><a href="#cb2-747"></a>	<span class="kw">gen</span> aa = _m==1
</span>
<span id="cb2-748"><a href="#cb2-748"></a>	<span class="kw">gen</span> bb = _m==2
</span>
<span id="cb2-749"><a href="#cb2-749"></a>	<span class="kw">gen</span> <span class="kw">cc</span> = aa | bb
</span>
<span id="cb2-750"><a href="#cb2-750"></a>	<span class="kw">egen</span> t0 = <span class="kw">total</span>(bb), <span class="kw">by</span>(n5 <span class="fu">year</span>)
</span>
<span id="cb2-751"><a href="#cb2-751"></a>	<span class="kw">replace</span> naicsX = n5+<span class="st">"X"</span> <span class="kw">if</span> t0~=0
</span>
<span id="cb2-752"><a href="#cb2-752"></a>	<span class="kw">sort</span> <span class="fu">year</span> naics
</span>
<span id="cb2-753"><a href="#cb2-753"></a>	<span class="kw">rename</span> <span class="dt">_merge</span> _merge6
</span>
<span id="cb2-754"><a href="#cb2-754"></a>	<span class="kw">drop</span> t0 n5 aa bb cc
</span>
<span id="cb2-755"><a href="#cb2-755"></a>
</span>
<span id="cb2-756"><a href="#cb2-756"></a>	*Go up a <span class="dv">level</span> <span class="kw">of</span> aggregation, (look <span class="kw">for</span> <span class="fu">missing</span> N5, within N4, and
</span>
<span id="cb2-757"><a href="#cb2-757"></a>	*change naicsX to N4+<span class="st">"XX"</span>
</span>
<span id="cb2-758"><a href="#cb2-758"></a>	<span class="kw">drop</span> <span class="kw">if</span> _merge6==2
</span>
<span id="cb2-759"><a href="#cb2-759"></a>	<span class="kw">gen</span> naics5 = <span class="fu">substr</span>(naics,1,5)
</span>
<span id="cb2-760"><a href="#cb2-760"></a>	<span class="kw">merge</span> <span class="fu">m</span>:1 naics5 <span class="fu">year</span> <span class="kw">using</span> input/naics/naics5_year
</span>
<span id="cb2-761"><a href="#cb2-761"></a>	<span class="kw">drop</span> x 
</span>
<span id="cb2-762"><a href="#cb2-762"></a>	<span class="kw">egen</span> x = <span class="fu">tag</span>(naics5 <span class="fu">year</span>)
</span>
<span id="cb2-763"><a href="#cb2-763"></a>	<span class="kw">tab</span> _merge
</span>
<span id="cb2-764"><a href="#cb2-764"></a>	<span class="kw">table</span> <span class="fu">year</span> <span class="dt">_merge</span> <span class="kw">if</span> x, c(<span class="kw">sum</span> man)
</span>
<span id="cb2-765"><a href="#cb2-765"></a>	<span class="kw">gen</span> n4 = <span class="fu">substr</span>(naics5,1,4)
</span>
<span id="cb2-766"><a href="#cb2-766"></a>	<span class="kw">gen</span> aa = <span class="dt">_merge</span>==1
</span>
<span id="cb2-767"><a href="#cb2-767"></a>	<span class="kw">gen</span> bb = <span class="dt">_merge</span>==2
</span>
<span id="cb2-768"><a href="#cb2-768"></a>	<span class="kw">gen</span> <span class="kw">cc</span> = aa | bb
</span>
<span id="cb2-769"><a href="#cb2-769"></a>	<span class="kw">egen</span> t0 = <span class="kw">total</span>(bb), <span class="kw">by</span>(n4 <span class="fu">year</span>)
</span>
<span id="cb2-770"><a href="#cb2-770"></a>	<span class="kw">gen</span> naicsX_old = naicsX
</span>
<span id="cb2-771"><a href="#cb2-771"></a>	<span class="kw">sort</span> naics5
</span>
<span id="cb2-772"><a href="#cb2-772"></a>	<span class="kw">replace</span> naicsX = n4+<span class="st">"XX"</span> <span class="kw">if</span> t0~=0
</span>
<span id="cb2-773"><a href="#cb2-773"></a>	<span class="kw">rename</span> <span class="dt">_merge</span> _merge5
</span>
<span id="cb2-774"><a href="#cb2-774"></a>	<span class="kw">drop</span> <span class="kw">if</span> _merge5==2
</span>
<span id="cb2-775"><a href="#cb2-775"></a>	<span class="kw">sort</span> <span class="fu">year</span> naicsX
</span>
<span id="cb2-776"><a href="#cb2-776"></a>	<span class="kw">drop</span> t0 n4 aa bb <span class="kw">cc</span> naicsX_old
</span>
<span id="cb2-777"><a href="#cb2-777"></a>	
</span>
<span id="cb2-778"><a href="#cb2-778"></a>	*Go up a <span class="dv">level</span> <span class="kw">of</span> aggregation, (look <span class="kw">for</span> <span class="fu">missing</span> N4, within N3, and
</span>
<span id="cb2-779"><a href="#cb2-779"></a>	*change naicsX to N3+<span class="st">"XXX"</span>
</span>
<span id="cb2-780"><a href="#cb2-780"></a>	<span class="kw">gen</span> naics4 = <span class="fu">substr</span>(naics,1,4)
</span>
<span id="cb2-781"><a href="#cb2-781"></a>	<span class="kw">merge</span> <span class="fu">m</span>:1 naics4 <span class="fu">year</span> <span class="kw">using</span> input/naics/naics4_year
</span>
<span id="cb2-782"><a href="#cb2-782"></a>	<span class="kw">drop</span> x 
</span>
<span id="cb2-783"><a href="#cb2-783"></a>	<span class="kw">egen</span> x = <span class="fu">tag</span>(naics4 <span class="fu">year</span>)
</span>
<span id="cb2-784"><a href="#cb2-784"></a>	<span class="kw">tab</span> _merge
</span>
<span id="cb2-785"><a href="#cb2-785"></a>	<span class="kw">table</span> <span class="fu">year</span> <span class="dt">_merge</span> <span class="kw">if</span> x, c(<span class="kw">sum</span> man)
</span>
<span id="cb2-786"><a href="#cb2-786"></a>	<span class="kw">gen</span> n3 = <span class="fu">substr</span>(naics4,1,3)
</span>
<span id="cb2-787"><a href="#cb2-787"></a>	<span class="kw">gen</span> aa = <span class="dt">_merge</span>==1
</span>
<span id="cb2-788"><a href="#cb2-788"></a>	<span class="kw">gen</span> bb = <span class="dt">_merge</span>==2
</span>
<span id="cb2-789"><a href="#cb2-789"></a>	<span class="kw">gen</span> <span class="kw">cc</span> = aa | bb
</span>
<span id="cb2-790"><a href="#cb2-790"></a>	<span class="kw">egen</span> t0 = <span class="kw">total</span>(bb), <span class="kw">by</span>(n3 <span class="fu">year</span>)
</span>
<span id="cb2-791"><a href="#cb2-791"></a>	<span class="kw">gen</span> naicsX_old = naicsX
</span>
<span id="cb2-792"><a href="#cb2-792"></a>	<span class="kw">sort</span> naics4
</span>
<span id="cb2-793"><a href="#cb2-793"></a>	<span class="kw">replace</span> naicsX = n3+<span class="st">"XXX"</span> <span class="kw">if</span> t0~=0
</span>
<span id="cb2-794"><a href="#cb2-794"></a>	<span class="kw">rename</span> <span class="dt">_merge</span> _merge4
</span>
<span id="cb2-795"><a href="#cb2-795"></a>	<span class="kw">drop</span> <span class="kw">if</span> _merge4==2
</span>
<span id="cb2-796"><a href="#cb2-796"></a>	<span class="kw">sort</span> <span class="fu">year</span> naicsX
</span>
<span id="cb2-797"><a href="#cb2-797"></a>	<span class="kw">drop</span> t0 n3 aa bb <span class="kw">cc</span> naicsX_old
</span>
<span id="cb2-798"><a href="#cb2-798"></a>	
</span>
<span id="cb2-799"><a href="#cb2-799"></a>
</span>
<span id="cb2-800"><a href="#cb2-800"></a>	*List the XXXs, XXs and Xs that are created <span class="kw">in</span> the preceding blocks
</span>
<span id="cb2-801"><a href="#cb2-801"></a>	*
</span>
<span id="cb2-802"><a href="#cb2-802"></a>	*		11119X 11133X 11141X 11251X 21211X 21223X 21231X 21232X 31131X 31135X 
</span>
<span id="cb2-803"><a href="#cb2-803"></a>	*		31141X 31161X 31171X 31199X 31311X 31322X 31324X 31331X 32121X 32191X 
</span>
<span id="cb2-804"><a href="#cb2-804"></a>	*		32222X 32223X 32311X 32312X 32531X 32541X 32599X 32629X 32733X 33142X 
</span>
<span id="cb2-805"><a href="#cb2-805"></a>	*		33151X 33152X 33211X 33231X 33261X 33299X 33311X 33331X 33351X 33391X 
</span>
<span id="cb2-806"><a href="#cb2-806"></a>	*		33411X 33461X 33512X 33522X 33611X 33631X 33699X 33712X 33721X 33911X 
</span>
<span id="cb2-807"><a href="#cb2-807"></a>	*		33993X 33999X
</span>
<span id="cb2-808"><a href="#cb2-808"></a>	*
</span>
<span id="cb2-809"><a href="#cb2-809"></a>	*		1121XX 1123XX 2111XX 3113XX 3118XX 3122XX 3133XX 3151XX 3152XX 3241XX 
</span>
<span id="cb2-810"><a href="#cb2-810"></a>	*		3261XX 3273XX 3312XX 3315XX 3327XX 5241XX
</span>
<span id="cb2-811"><a href="#cb2-811"></a>	*
</span>
<span id="cb2-812"><a href="#cb2-812"></a>	*		113XXX 114XXX 332XXX 511XXX 524XXX
</span>
<span id="cb2-813"><a href="#cb2-813"></a>	*
</span>
<span id="cb2-814"><a href="#cb2-814"></a>	*
</span>
<span id="cb2-815"><a href="#cb2-815"></a>	<span class="kw">gen</span> n=<span class="fu">strpos</span>(naicsX,<span class="st">"X"</span>)
</span>
<span id="cb2-816"><a href="#cb2-816"></a>	<span class="kw">tab</span> <span class="fu">year</span> n
</span>
<span id="cb2-817"><a href="#cb2-817"></a>	<span class="kw">tab</span> naicsX <span class="kw">if</span> n==4
</span>
<span id="cb2-818"><a href="#cb2-818"></a>	<span class="kw">tab</span> naicsX <span class="kw">if</span> n==5
</span>
<span id="cb2-819"><a href="#cb2-819"></a>	<span class="kw">tab</span> naicsX <span class="kw">if</span> n==6
</span>
<span id="cb2-820"><a href="#cb2-820"></a>	
</span>
<span id="cb2-821"><a href="#cb2-821"></a>	<span class="kw">if</span> <span class="st">"`t'"</span> == <span class="st">"m"</span> {
</span>
<span id="cb2-822"><a href="#cb2-822"></a>		<span class="kw">local</span> tt = <span class="st">"imports"</span>
</span>
<span id="cb2-823"><a href="#cb2-823"></a>	}
</span>
<span id="cb2-824"><a href="#cb2-824"></a>	<span class="kw">if</span> <span class="st">"`t'"</span> == <span class="st">"x"</span> {
</span>
<span id="cb2-825"><a href="#cb2-825"></a>		<span class="kw">local</span> tt = <span class="st">"exports"</span>
</span>
<span id="cb2-826"><a href="#cb2-826"></a>	}
</span>
<span id="cb2-827"><a href="#cb2-827"></a>	<span class="kw">keep</span> commodity <span class="fu">year</span> sic sic_matchtype naics naicsX naics_matchtype
</span>
<span id="cb2-828"><a href="#cb2-828"></a>	<span class="kw">sort</span> <span class="fu">year</span> commodity
</span>
<span id="cb2-829"><a href="#cb2-829"></a>	cd <span class="st">"$C"</span>
</span>
<span id="cb2-830"><a href="#cb2-830"></a>	<span class="kw">save</span>           hs_sic_naics_<span class="ot">`tt'</span>_89_117_20180927, replace
</span>
<span id="cb2-831"><a href="#cb2-831"></a>	<span class="kw">outsheet</span> <span class="kw">using</span> hs_sic_naics_<span class="ot">`tt'</span>_89_117_20180927.csv, replace
</span>
<span id="cb2-832"><a href="#cb2-832"></a>
</span>
<span id="cb2-833"><a href="#cb2-833"></a>}
</span>
<span id="cb2-834"><a href="#cb2-834"></a>
</span>
<span id="cb2-835"><a href="#cb2-835"></a>
</span>
<span id="cb2-836"><a href="#cb2-836"></a>
</span>
<span id="cb2-837"><a href="#cb2-837"></a>
</span>
<span id="cb2-838"><a href="#cb2-838"></a>
</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<aside><ol class="aside-footnotes"><li id="fn2"><p>Kandel et al.&nbsp;(2011). <strong>Research directions in data wrangling: Visualizations and transformations for usable and credible data.</strong> <em>Information Visualization</em>, 10(4), 271-288.</p></li></ol></aside></section></section>
<section>
<section id="proposed-contributions" class="title-slide slide level1 center">
<h1>Proposed Contributions</h1>

</section>
<section id="proposed-crossmaps-approach" class="slide level2">
<h2>Proposed Crossmaps Approach</h2>
<div class="columns">
<div class="column" style="width:45%;">
<div class="quarto-figure quarto-figure-center" style="margin: 0; padding: 0">
<figure>
<p><img data-src="images/diagram-data-transform-xmap-v2.png" height="400"></p>
</figure>
</div>
<div>
<ul>
<li class="fragment">standardised mapping object</li>
<li class="fragment">validate via graph properties</li>
</ul>
</div>
</div><div class="column" style="width:55%;">
<div>
<p><span class="fragment">Equivalent representations:</span></p>
<ul>
<li class="fragment"><p><strong>Bi-Partite Graph</strong>: source nodes, target nodes + weighted edges</p></li>
<li class="fragment"><p><strong>Adjacency Matrix</strong>: has the same constraints as a markov chain transition matrix</p></li>
<li class="fragment"><p><strong>Edge List</strong>: apply transformation using database join, mutate and summarise operations.</p></li>
</ul>
</div>
</div>
</div>
</section>
<section id="proposed-visualisation-and-encodings" class="slide level2">
<h2>Proposed visualisation (and encodings)</h2>
<div class="columns">
<div class="column" style="width:45%;">
<p><img data-src="images/plot-anzsco-isco-bigraph.png"></p>
</div><div class="column" style="width:55%;">
<p><span class="fragment">Highlight transformation attributes:</span></p>
<div>
<ul>
<li class="fragment">split vs.&nbsp;not split:
<ul>
<li class="fragment">text style, line style, <strong>layout/ordering</strong></li>
</ul></li>
<li class="fragment">split proportion:
<ul>
<li class="fragment">text labels on links</li>
</ul></li>
<li class="fragment">target composition:
<ul>
<li class="fragment">line style, colour saturation, <strong>layout/ordering</strong></li>
</ul></li>
</ul>
</div>
</div>
</div>
</section>
<section id="discussion" class="slide level2">
<h2>Discussion</h2>
<div>
<ul>
<li class="fragment"><strong>Why abstract (and visualise) cross-taxonomy transformations?</strong>
<ul>
<li class="fragment">Document data provenance at task level rather than dataset level</li>
<li class="fragment">Validate data quality. Audit and reuse data wrangling code</li>
<li class="fragment">Explore statistical properties and imputation metrics</li>
</ul></li>
<li class="fragment"><strong>How to scale up via existing graph and visualisation idioms?</strong>
<ul>
<li class="fragment">Interactivity (e.g.&nbsp;tooltips for category description labels)</li>
<li class="fragment">Filter by graph properties (e.g.&nbsp;leave out one-to-unique links)</li>
<li class="fragment">Aggregate/Collapse/Embed sub-graphs (e.g.&nbsp;one-to-shared links) or sequential/concurrent transformations</li>
</ul></li>
</ul>
</div>
</section></section>
<section>
<section id="appendix" class="title-slide slide level1 center">
<h1>Appendix</h1>

</section>
<section id="current-work-imputation-metrics-and-imprints" class="slide level2">
<h2>Current Work: Imputation metrics and imprints</h2>
<div class="columns">
<div class="column" style="width:60%;">
<div class="quarto-figure quarto-figure-left">
<figure>
<p><img data-src="images/isiccomb_rev3_TRUEonly.png"></p>
</figure>
</div>
</div><div class="column" style="width:40%;">
<ul>
<li>How much of an ex-post harmonised dataset is imputed?</li>
<li>Which transformed observations are less reliable?</li>
<li>Can we quantify the degree of imputation?</li>
</ul>
</div>
</div>
</section>
<section id="cross-taxonomy-transformation-via-database-operations" class="slide level2">
<h2>Cross-taxonomy transformation via database operations</h2>
<ul>
<li>Transformations always involves <strong>recoding category labels</strong>:
<ul>
<li><span style="font-size: 0.6em"><code>111212: Defence Force Senior Officer --&gt; 0110: Commissioned armed forces officers</code></span></li>
</ul></li>
<li>In addition to these <strong>character transformations</strong>, <strong>numeric transformation</strong> can include:
<ul>
<li>“pass-through” of numeric values – i.e.&nbsp;one-to-unique relations</li>
<li>numeric aggregation – i.e.&nbsp;one-to-shared relations</li>
<li>numeric redistribution – i.e.&nbsp;one-to-many relations</li>
</ul></li>
</ul>
</section>
<section id="cross-taxonomy-transformation-via-database-operations-1" class="slide level2">
<h2>Cross-taxonomy transformation via database operations</h2>
<p>We can encompass the string and numeric operations in the following tabular operations:</p>
<div class="quarto-layout-panel">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<ol type="1">
<li><strong>Rename</strong> original categories into target categories</li>
<li><strong>Multiply</strong> source node values by link weight.</li>
<li><strong>Summarise</strong> mutated values by target node.</li>
</ol>
</div>
<div class="cell quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<div class="sourceCode cell-code" id="cb3" data-code-line-numbers="3-6|7|8,9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="do">## mock up of apply_xmap()</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>apply_xmap <span class="ot">&lt;-</span> <span class="cf">function</span>(.data, .xmap) {</span>
<span id="cb3-3"><a href="#cb3-3"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb3-4"><a href="#cb3-4"></a>        <span class="at">x =</span> .data,</span>
<span id="cb3-5"><a href="#cb3-5"></a>        <span class="at">y =</span> .xmap,</span>
<span id="cb3-6"><a href="#cb3-6"></a>        <span class="at">by =</span> <span class="st">"anzsco22"</span>) <span class="sc">|&gt;</span></span>
<span id="cb3-7"><a href="#cb3-7"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">part_count =</span> count <span class="sc">*</span> weights) <span class="sc">|&gt;</span></span>
<span id="cb3-8"><a href="#cb3-8"></a>        dplyr<span class="sc">::</span><span class="fu">group_by</span>(isco8) <span class="sc">|&gt;</span></span>
<span id="cb3-9"><a href="#cb3-9"></a>        dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">new_count =</span> <span class="fu">sum</span>(part_count))</span>
<span id="cb3-10"><a href="#cb3-10"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<!-- > Tackling domain applications via mathematical abstractions can create useful derived data for visual encoding
> Information visualisation can be used to expore and communicate complex data wrangling decisions -->
<div class="footer footer-default">

</div>
</section></section>

    </div>
  </div>

  <script>window.backupDefine = window.define; window.define = undefined;</script>
  <script src="slides_files/libs/revealjs/dist/reveal.js"></script>
  <!-- reveal.js plugins -->
  <script src="slides_files/libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script>
  <script src="slides_files/libs/revealjs/plugin/pdf-export/pdfexport.js"></script>
  <script src="slides_files/libs/revealjs/plugin/reveal-menu/menu.js"></script>
  <script src="slides_files/libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script>
  <script src="slides_files/libs/revealjs/plugin/quarto-tone/tone.js"></script>
  <script src="slides_files/libs/revealjs/plugin/quarto-support/support.js"></script>
  

  <script src="slides_files/libs/revealjs/plugin/notes/notes.js"></script>
  <script src="slides_files/libs/revealjs/plugin/search/search.js"></script>
  <script src="slides_files/libs/revealjs/plugin/zoom/zoom.js"></script>
  <script src="slides_files/libs/revealjs/plugin/math/math.js"></script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': true,
'previewLinksAuto': false,
'smaller': false,
'pdfSeparateFragments': false,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 1,
'autoAnimateUnmatched': true,
'menu': {"side":"left","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.togglePdfExport(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"}],"openButton":true},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: false,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: 'c/t',

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: false,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'linear',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'none',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'none',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1280,

        height: 720,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, QuartoTone, QuartoSupport,

          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    <script>
    // Copy over background colors to new div
    divs = document.querySelectorAll('[data-background-color]');

    Array.from(divs).map(function (x) {
      const color = x.dataset.backgroundColor;

      var new_div = document.createElement('div');
      new_div.setAttribute("class", "background-color-div");
      new_div.style.backgroundColor = color;
      x.appendChild(new_div);
      x.removeAttribute("data-background-color");
    })

    // Remove background colors from backgrounds div
    Array.from(
      document.querySelectorAll("[data-background-hash]")
    ).map(function (x) {
      x.removeAttribute("data-background-hash");
      x.style.backgroundColor = null;
    })
    </script>

    <script>
    // Copy over background images to new div
    divs = document.querySelectorAll('[data-background-image]');

    Array.from(divs).map(function (x) {
      var new_div = document.createElement('div');
      new_div.setAttribute("class", "background-image-div");

      if (x.dataset.backgroundImage != undefined) {
        new_div.style.backgroundImage = "url(" + x.dataset.backgroundImage + ")";
        x.removeAttribute("data-background-image");
      }
      if (x.dataset.backgroundSize != undefined) {
        new_div.style.backgroundSize = x.dataset.backgroundSize;
        x.removeAttribute("data-background-size");
      }
      if (x.dataset.backgroundPosition != undefined) {
        new_div.style.backgroundPosition = x.dataset.backgroundPosition;
        x.removeAttribute("data-background-position");
      }
      if (x.dataset.backgroundRepeat != undefined) {
        new_div.style.backgroundRepeat = x.dataset.backgroundRepeat;
        x.removeAttribute("data-background-repeat");
      }
      if (x.dataset.backgroundOpacity != undefined) {
        new_div.style.backgroundOpacity = x.dataset.backgroundOpacity;
        x.removeAttribute("data-background-opacity");
      }

      x.appendChild(new_div);
    })
    </script>

    <script>
    // Copy over background vidoes

    // Run once when we load
    var video_div = document.querySelectorAll(".backgrounds video");
    var slide_div = document.querySelectorAll("[data-background-video]");

    for (let i = 0; i < video_div.length; i++) {
      video_div[i].setAttribute("class", "background-video-div");

      slide_div[i].appendChild(video_div[i]);
      slide_div[i].removeAttribute("data-background-video");
    }

    Reveal.getCurrentSlide().querySelectorAll("video").forEach(x => x.play());

    // Each time we advance slides, as the background videos aren't loaded
    // unless they are a few slides away
    Reveal.on('slidechanged', event => {
      var video_div = document.querySelectorAll(".backgrounds video");
      var slide_div = document.querySelectorAll("[data-background-video]");

      for (let i = 0; i < video_div.length; i++) {
        video_div[i].setAttribute("class", "background-video-div");

        slide_div[i].appendChild(video_div[i]);
        slide_div[i].removeAttribute("data-background-video");
      }

      Reveal.getCurrentSlide().querySelectorAll("video").forEach(x => x.play());
    });
    </script>

    <script>
    // Copy over background vidoes

    // Run once when we load
    var iframe_div = document.querySelectorAll(".backgrounds iframe");
    var slide_div = document.querySelectorAll("[data-background-iframe]");

    for (let i = 0; i < iframe_div.length; i++) {
      iframe_div[i].setAttribute("class", "background-iframe-div");

      slide_div[i].appendChild(iframe_div[i]);
      slide_div[i].removeAttribute("data-background-iframe");
    }

    // Each time we advance slides, as the background videos aren't loaded
    // unless they are a few slides away
    Reveal.on('slidechanged', event => {
      var iframe_div = document.querySelectorAll(".backgrounds iframe");
      var slide_div = document.querySelectorAll("[data-background-iframe]");

      for (let i = 0; i < iframe_div.length; i++) {
        iframe_div[i].setAttribute("class", "background-iframe-div");

        slide_div[i].appendChild(iframe_div[i]);
        slide_div[i].removeAttribute("data-background-iframe");
      }
    });
    </script>

    <script>
    // Clean up slide background styles
    divs = document.querySelectorAll('.slide-background-content');
    Array.from(divs).map(function (x) {
      x.style = null;
    })
    </script>

    <script>
    // Move menu button
    menu_div = document.querySelector(".slide-menu-button");
    document.querySelector(".slides").appendChild(menu_div);

    // Move progress bar
    menu_div = document.querySelector(".progress");
    document.querySelector(".slides").appendChild(menu_div);
    </script>

    
    <script>
      // htmlwidgets need to know to resize themselves when slides are shown/hidden.
      // Fire the "slideenter" event (handled by htmlwidgets.js) when the current
      // slide changes (different for each slide format).
      (function () {
        // dispatch for htmlwidgets
        function fireSlideEnter() {
          const event = window.document.createEvent("Event");
          event.initEvent("slideenter", true, true);
          window.document.dispatchEvent(event);
        }

        function fireSlideChanged(previousSlide, currentSlide) {
          fireSlideEnter();

          // dispatch for shiny
          if (window.jQuery) {
            if (previousSlide) {
              window.jQuery(previousSlide).trigger("hidden");
            }
            if (currentSlide) {
              window.jQuery(currentSlide).trigger("shown");
            }
          }
        }

        // hookup for slidy
        if (window.w3c_slidy) {
          window.w3c_slidy.add_observer(function (slide_num) {
            // slide_num starts at position 1
            fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);
          });
        }

      })();
    </script>

    <script id="quarto-html-after-body" type="application/javascript">
    window.document.addEventListener("DOMContentLoaded", function (event) {
      const toggleBodyColorMode = (bsSheetEl) => {
        const mode = bsSheetEl.getAttribute("data-mode");
        const bodyEl = window.document.querySelector("body");
        if (mode === "dark") {
          bodyEl.classList.add("quarto-dark");
          bodyEl.classList.remove("quarto-light");
        } else {
          bodyEl.classList.add("quarto-light");
          bodyEl.classList.remove("quarto-dark");
        }
      }
      const toggleBodyColorPrimary = () => {
        const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
        if (bsSheetEl) {
          toggleBodyColorMode(bsSheetEl);
        }
      }
      toggleBodyColorPrimary();  
      const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
      tabsets.forEach(function(tabset) {
        const tabby = new Tabby('#' + tabset.id);
      });
      const isCodeAnnotation = (el) => {
        for (const clz of el.classList) {
          if (clz.startsWith('code-annotation-')) {                     
            return true;
          }
        }
        return false;
      }
      const clipboard = new window.ClipboardJS('.code-copy-button', {
        text: function(trigger) {
          const codeEl = trigger.previousElementSibling.cloneNode(true);
          for (const childEl of codeEl.children) {
            if (isCodeAnnotation(childEl)) {
              childEl.remove();
            }
          }
          return codeEl.innerText;
        }
      });
      clipboard.on('success', function(e) {
        // button target
        const button = e.trigger;
        // don't keep focus
        button.blur();
        // flash "checked"
        button.classList.add('code-copy-button-checked');
        var currentTitle = button.getAttribute("title");
        button.setAttribute("title", "Copied!");
        let tooltip;
        if (window.bootstrap) {
          button.setAttribute("data-bs-toggle", "tooltip");
          button.setAttribute("data-bs-placement", "left");
          button.setAttribute("data-bs-title", "Copied!");
          tooltip = new bootstrap.Tooltip(button, 
            { trigger: "manual", 
              customClass: "code-copy-button-tooltip",
              offset: [0, -8]});
          tooltip.show();    
        }
        setTimeout(function() {
          if (tooltip) {
            tooltip.hide();
            button.removeAttribute("data-bs-title");
            button.removeAttribute("data-bs-toggle");
            button.removeAttribute("data-bs-placement");
          }
          button.setAttribute("title", currentTitle);
          button.classList.remove('code-copy-button-checked');
        }, 1000);
        // clear code selection
        e.clearSelection();
      });
      function tippyHover(el, contentFn) {
        const config = {
          allowHTML: true,
          content: contentFn,
          maxWidth: 500,
          delay: 100,
          arrow: false,
          appendTo: function(el) {
              return el.closest('section.slide') || el.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start'
        };
          config['offset'] = [0,0];
          config['maxWidth'] = 700;
        window.tippy(el, config); 
      }
      const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
      for (var i=0; i<noterefs.length; i++) {
        const ref = noterefs[i];
        tippyHover(ref, function() {
          // use id or data attribute instead here
          let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
          try { href = new URL(href).hash; } catch {}
          const id = href.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          return note.innerHTML;
        });
      }
      const findCites = (el) => {
        const parentEl = el.parentElement;
        if (parentEl) {
          const cites = parentEl.dataset.cites;
          if (cites) {
            return {
              el,
              cites: cites.split(' ')
            };
          } else {
            return findCites(el.parentElement)
          }
        } else {
          return undefined;
        }
      };
      var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
      for (var i=0; i<bibliorefs.length; i++) {
        const ref = bibliorefs[i];
        const citeInfo = findCites(ref);
        if (citeInfo) {
          tippyHover(citeInfo.el, function() {
            var popup = window.document.createElement('div');
            citeInfo.cites.forEach(function(cite) {
              var citeDiv = window.document.createElement('div');
              citeDiv.classList.add('hanging-indent');
              citeDiv.classList.add('csl-entry');
              var biblioDiv = window.document.getElementById('ref-' + cite);
              if (biblioDiv) {
                citeDiv.innerHTML = biblioDiv.innerHTML;
              }
              popup.appendChild(citeDiv);
            });
            return popup.innerHTML;
          });
        }
      }
    });
    </script>
    

</body></html>